<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog â€“ Vitalora</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=2">
  <link rel="stylesheet" href="/assets/css/header.css">
  <link rel="stylesheet" href="/assets/css/fonts.css?v=12">
  <link rel="stylesheet" href="/assets/css/footer.css?v=12">
  <style>
    body { font-family: 'Quicksand', sans-serif; background:#EDF2FB; color:#333; }
    .blog-post-container{max-width:1000px;margin:40px auto;padding:40px;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
    .blog-post-header{margin-bottom:24px}
    .blog-post-title{font-size:42px;color:#333;margin-bottom:12px;font-weight:700;line-height:1.2;letter-spacing:-0.02em}
    .blog-post-meta{display:flex;flex-direction:column;gap:8px;color:#6b7280;font-size:15px;margin-bottom:16px;font-weight:500}
    .blog-post-meta-item{display:flex;align-items:center;gap:8px}
    .blog-post-date::before,.blog-post-read-time::before{content:"";width:16px;height:16px;background-size:contain;background-repeat:no-repeat}
    .blog-post-date::before{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'/%3E%3C/svg%3E")}
    .blog-post-read-time::before{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E")}
    .blog-post-featured-image{width:100%;height:400px;background:#e5e7eb;border-radius:12px;margin:24px 0 32px;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:16px;font-weight:500;overflow:hidden}
    .blog-post-featured-image img{width:100%;height:100%;object-fit:cover;border-radius:12px}
    .blog-post-content{padding:0;line-height:1.8;color:#333;font-size:18px}
    .blog-post-content h1,.blog-post-content h2,.blog-post-content h3,.blog-post-content h4{color:#333;margin-top:48px;margin-bottom:20px;font-weight:700;line-height:1.3;letter-spacing:-0.01em}
    /* Ensure H2â€“H4 are standard black like H1 */
    .blog-post-content h2,.blog-post-content h3,.blog-post-content h4{color:#333}
    .blog-post-content p{margin-bottom:24px;font-size:18px;line-height:1.8}
    .blog-post-content blockquote{background:#2954B4;color:#fff;padding:20px 24px;margin:24px 0;border-radius:8px;border-left:none;box-shadow:0 4px 12px rgba(41,84,179,0.2);font-size:16px;line-height:1.5;font-weight:500;position:relative}
    .blog-post-content blockquote *{color:#fff}
    .blog-post-content blockquote:before{content:"\201C";font-size:24px;color:rgba(255,255,255,0.7);position:absolute;left:8px;top:8px}
    .blog-post-content blockquote:after{content:"\201D";font-size:24px;color:rgba(255,255,255,0.7);position:absolute;right:8px;bottom:8px}
    
    /* Support "Kort" summary box from editor */
    .blog-post-content .summary-box{background:#fff;border-radius:8px;margin:16px 0;box-shadow:0 2px 8px rgba(0,0,0,0.1);overflow:hidden;border-left:4px solid #2954B4}
    .blog-post-content .summary-header{background:#2954B4;color:#fff;padding:12px 16px;display:flex;align-items:center;gap:8px;font-weight:600}
    .blog-post-content .summary-header .icon{width:20px;height:20px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px}
    .blog-post-content .summary-content{padding:16px;color:#333;min-height:40px}
    @media (max-width:768px){.blog-post-container{margin:20px auto;padding:20px}.blog-post-title{font-size:32px}.blog-post-featured-image{height:200px;margin:20px 0 24px}.blog-post-content{font-size:16px}}
  </style>
<link rel="icon" type="image/webp" href="/assets/images/vitalora logo.webp">
<link rel="shortcut icon" type="image/webp" href="/assets/images/vitalora logo.webp">
</head>
<body>
  <script defer src="/assets/js/header.js?v=5"></script>
  <div data-include="site-header"></div>
  
  <main class="main-content">
    <div class="blog-post-container">
      <div class="blog-post-header">
        <div class="blog-post-meta">
          <span class="blog-post-meta-item blog-post-date" id="post-date">-</span>
          <span class="blog-post-meta-item blog-post-read-time" id="post-read-time">-</span>
        </div>
        <h1 id="post-title" class="blog-post-title">Laden...</h1>
      </div>
      <div class="blog-post-featured-image" id="featured-image">Afbeelding placeholder</div>
      <div class="blog-post-content" id="post-content">Nog invullen.</div>
    </div>
  </main>

  <script>
    (async function(){
      const API_BASE = '/api/blogs';

      function hasStaffAccess(){
        return document.cookie.split(';').some(function(part){
          return part.trim().startsWith('staff_access_ok=');
        });
      }

      function slugToTitle(value){
        return (value || '')
          .replace(/-/g, ' ')
          .replace(/\b\w/g, function(letter){ return letter.toUpperCase(); });
      }

      function formatReadTime(value){
        const number = Number(value);
        const minutes = Number.isFinite(number) && !Number.isNaN(number) && number > 0
          ? Math.round(number)
          : 5;
        return minutes;
      }

      async function fetchPostFromApi(slug){
        try {
          const res = await fetch(API_BASE + '?slug=' + encodeURIComponent(slug), { cache: 'no-store' });
          if (res.status === 404) return null;
          if (!res.ok) throw new Error('API fout: ' + res.status);
          const data = await res.json();
          return data?.data || null;
        } catch (error) {
          console.warn('Kon blogpost niet uit API laden:', error);
          return null;
        }
      }

      function loadFromLocalStorage(slug){
        try {
          const stored = localStorage.getItem('vitalora_blog_posts');
          if (!stored) return null;
          const parsed = JSON.parse(stored);
          if (!Array.isArray(parsed)) return null;
          return parsed.find(function(post){
            return post && post.slug === slug;
          }) || null;
        } catch (error) {
          console.warn('Kon localStorage niet lezen:', error);
          return null;
        }
      }

      async function fetchStatic(slug){
        try {
          const res = await fetch('/' + encodeURIComponent(slug) + '.html', { credentials: 'same-origin' });
          if (!res.ok) return null;
          const html = await res.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const h1 = doc.querySelector('.blog-title, h1');
          const content = doc.querySelector('.blog-content, article, main');
          const dateEl = doc.querySelector('.blog-date');
          return {
            title: h1 ? h1.textContent.trim() : slugToTitle(slug),
            content: content ? content.innerHTML : '<p>Geen inhoud gevonden.</p>',
            publishedDate: dateEl ? dateEl.textContent.trim() : ''
          };
        } catch (error) {
          console.warn('Kon statisch fallback bestand niet laden:', error);
          return null;
        }
      }

      function cachePost(post){
        try {
          const key = 'vitalora_blog_posts';
          const stored = localStorage.getItem(key);
          const parsed = stored ? JSON.parse(stored) : [];
          const list = Array.isArray(parsed) ? parsed : [];
          const others = list.filter(function(item){
            if (!item) return false;
            if (post.id && item.id) return Number(item.id) !== Number(post.id);
            return item.slug !== post.slug;
          });
          others.push(post);
          localStorage.setItem(key, JSON.stringify(others));
        } catch (error) {
          console.warn('Kon post niet cachen:', error);
        }
      }

      function normalizeSummaryHeaders(){
        try {
          var headers = document.querySelectorAll('.summary-header');
          headers.forEach(function(h){
            var icon = h.querySelector('.icon');
            h.innerHTML = '';
            var iconEl = document.createElement('div');
            iconEl.className = 'icon';
            iconEl.textContent = 'ðŸ“‹';
            h.appendChild(iconEl);
            h.appendChild(document.createTextNode(' In het kort...'));
          });
        } catch(_) {}
      }

      const params = new URLSearchParams(location.search);
      let slug = params.get('slug');
      if (!slug) {
        const path = (location.pathname || '/').replace(/\/$/, '');
        const segments = path.split('/').filter(Boolean);
        const last = segments[segments.length - 1] || '';
        slug = (last && last !== 'post.html') ? last : '';
      }

      const titleEl = document.getElementById('post-title');
      const contentEl = document.getElementById('post-content');
      const dateEl = document.getElementById('post-date');
      const readTimeEl = document.getElementById('post-read-time');
      const featuredWrap = document.getElementById('featured-image');

      if (!slug) {
        titleEl.textContent = 'Blog post niet gevonden';
        contentEl.innerHTML = '<p>Geen slug opgegeven.</p>';
        dateEl.textContent = '-';
        readTimeEl.textContent = '-';
        return;
      }

      titleEl.textContent = slugToTitle(slug);

      let post = await fetchPostFromApi(slug);
      if (!post) {
        post = loadFromLocalStorage(slug);
      }
      if (!post) {
        post = await fetchStatic(slug);
      }

      if (!post) {
        dateEl.textContent = '-';
        readTimeEl.textContent = '-';
        contentEl.innerHTML = '<p>Deze blog post is nog leeg.</p>';
        return;
      }

      if (post.status && post.status !== 'published' && !hasStaffAccess()) {
        titleEl.textContent = 'Artikel niet gepubliceerd';
        dateEl.textContent = '-';
        readTimeEl.textContent = '-';
        contentEl.innerHTML = '<p>Dit artikel is nog niet beschikbaar.</p>';
        if (featuredWrap) {
          featuredWrap.textContent = 'Afbeelding placeholder';
        }
        return;
      }

      document.title = (post.metaTitle || post.title || slugToTitle(slug)) + ' - Vitalora';
      titleEl.textContent = post.title || slugToTitle(slug);

      const displayDate = post.publishedDate || post.publishDate || '';
      dateEl.textContent = displayDate || '-';
      readTimeEl.textContent = formatReadTime(post.readTime) + ' min';

      if (post.content && typeof post.content === 'string' && post.content.trim()) {
        contentEl.innerHTML = post.content;
      } else if (post.text || post.excerpt) {
        contentEl.textContent = post.text || post.excerpt;
      } else {
        contentEl.innerHTML = '<p>Deze blog post is nog leeg.</p>';
      }

      normalizeSummaryHeaders();

      try {
        function enforceRender(){
          try {
            if (titleEl && !titleEl.textContent.trim()) {
              titleEl.textContent = post.title || slugToTitle(slug);
            }
            if (contentEl) {
              const html = (contentEl.innerHTML || '').trim();
              if (!html || html === 'Nog invullen.' || html.indexOf('Nog invullen') !== -1) {
                contentEl.innerHTML = post.content || '<p>Deze blog post is nog leeg.</p>';
              }
            }
          } catch (_) {}
        }
        const observer = new MutationObserver(function(){ enforceRender(); });
        observer.observe(contentEl, { childList: true, characterData: true, subtree: true });
        setTimeout(enforceRender, 100);
        setTimeout(enforceRender, 600);
        setTimeout(enforceRender, 1500);
      } catch (_) {}

      try {
        if (featuredWrap) {
          if (post.featuredImage && typeof post.featuredImage === 'string' && post.featuredImage.trim()) {
            const img = document.createElement('img');
            img.src = post.featuredImage;
            img.alt = post.title || slug;
            featuredWrap.innerHTML = '';
            featuredWrap.appendChild(img);
          } else {
            const tmp = document.createElement('div');
            tmp.innerHTML = post.content || '';
            const firstImg = tmp.querySelector('img');
            if (firstImg && firstImg.src) {
              const img = document.createElement('img');
              img.src = firstImg.src;
              img.alt = post.title || slug;
              featuredWrap.innerHTML = '';
              featuredWrap.appendChild(img);
            }
          }
        }
      } catch (error) {
        console.warn('Kon headerafbeelding niet renderen:', error);
      }

      try {
        var canonical = document.querySelector('link[rel="canonical"]');
        if (!canonical) {
          canonical = document.createElement('link');
          canonical.setAttribute('rel', 'canonical');
          document.head.appendChild(canonical);
        }
        canonical.setAttribute('href', location.origin + '/' + encodeURIComponent(slug));
      } catch (_) {}

      if (post && (post.id || post.slug)) {
        cachePost(post);
      }
    })();
  </script>
</body>
</html>

