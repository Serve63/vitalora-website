<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Personeel Dashboard</title>
  <link rel="stylesheet" href="styles.css?v=2" />
  <link rel="stylesheet" href="/assets/css/header.css?v=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/fonts.css?v=12">
  <style>
    :root{--brand:#3A9AEA;--ink:#0f172a;--muted:#64748b}
    body{background:#f3f6fb}
    .app{display:grid;grid-template-columns:240px 1fr;min-height:calc(100vh - 64px)}
    
    .sidenav{background:#ffffff;border-right:1px solid #e5e7eb;padding:22px 16px}
    .sidenav h4{font-size:12px;color:#94a3b8;text-transform:uppercase;letter-spacing:.14em;margin-bottom:10px}

    .navlist{display:flex;flex-direction:column;gap:6px}
    .navlist a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:#334155;text-decoration:none;font-weight:600}

    .navlist a.active,.navlist a:hover{background:#eef7fe;color:#1d4ed8}

    .content{padding:26px}
    .heading{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .heading h1{margin:0;color:#333}
    .muted{color:var(--muted);font-size:14px}

    .kpi-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;margin:18px 0 24px}
    .kpi{grid-column:span 3;background:#ffffff;border:1px solid #e6edf7;border-radius:16px;box-shadow:0 2px 8px rgba(15,23,42,.06);padding:18px}
    /* Highlight today's revenue card */
    #kpi-today{border:2px solid #10b981}

    .kpi h3{margin:0 0 8px;color:#334155;font-weight:700}
    .kpi .val{font-size:30px;font-weight:800;color:var(--ink)}
    .kpi .sub{font-size:12px;color:#94a3b8;margin-top:4px}

    .card{background:#fff;border:1px solid #e6edf7;border-radius:16px;box-shadow:0 10px 24px rgba(15,23,42,.06), inset 0 1px 0 #fff;padding:20px}

    .card h3{margin:0 0 10px;color:#333}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px}
    th{color:#64748b;font-weight:700}

    @media(max-width:1024px){.kpi{grid-column:span 6}}
    @media(max-width:768px){.app{grid-template-columns:1fr}.sidenav{display:none}.kpi{grid-column:span 12}#blogs{display:none}}
    

  </style>
<link rel="icon" type="image/webp" href="/assets/images/vitalora logo.webp">
<link rel="shortcut icon" type="image/webp" href="/assets/images/vitalora logo.webp">
</head>
<body>
  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="header-inner">
      <a class="logo" href="/">
        <span class="logo-text">Vitalora.nl</span>
      </a>
      
      <div class="header-buttons">
        <!-- Header buttons removed for dashboard -->
      </div>
    </div>
  </header>

  <div class="app">
    <aside class="sidenav">
      <h4>Menu</h4>
      <nav class="navlist">
        <a class="active" href="#">Overzicht</a>
        <a href="/klanten.html">Klanten</a>
      </nav>
    </aside>

    <main class="content">
      <div class="heading">
        <h1>Personeel Dashboard</h1>
      </div>

      <section class="kpi-grid">
        <div class="kpi"><h3>Alltime omzet</h3><div class="val" id="rev-all">€ 0,00</div></div>

        <div class="kpi"><h3>Omzet dit jaar</h3><div class="val" id="rev-year">€ 0,00</div></div>

        <div class="kpi"><h3>Omzet deze maand</h3><div class="val" id="rev-month">€ 0,00</div></div>

        <div class="kpi" id="kpi-today"><h3>Omzet vandaag</h3><div class="val" id="rev-today">€ 0,00</div></div>

      </section>

      <section id="blogs" class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 12px; flex-wrap: wrap;">
          <h3 style="margin: 0;">Blogbeheer</h3>
          <div style="display:flex; gap:8px; align-items:center;">
          <a href="/blog-editor.html" style="background: #10b981 !important; color: white !important; padding: 8px 16px !important; border-radius: 6px !important; text-decoration: none !important; font-weight: 600 !important; font-size: 14px !important; border: none !important; display: inline-block !important;">Blog aanmaken</a>
          </div>
        </div>
        <p class="muted">Klik op een item om het bronbestand te openen. CMS-koppeling kan later toegevoegd worden.</p>

        <table>
          <thead><tr><th>Titel</th><th>Status</th><th style="text-align:right;">Actie</th></tr></thead>
          <tbody id="blog-posts-table">
          </tbody>
        </table>
      </section>

    </main>
  </div>



  <script>
    (function(){
      // Server-side gated via cookie. As a small UX guard, verify at load.
      fetch('/api/staff/guard', { credentials: 'same-origin' })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(() => {})
        .catch(() => { window.location.href='/personeel'; });
      // Revenue fetch
      async function loadRevenue(){
        try{
          const res = await fetch('/api/orders-summary');
          const data = await res.json();
          if(!res.ok) throw new Error(JSON.stringify(data));
          function fmt(v){ return '€ ' + (Number(v||0).toFixed(2)).replace('.', ','); }
          document.getElementById('rev-all').textContent = fmt(data.allTime);
          document.getElementById('rev-year').textContent = fmt(data.year);
          document.getElementById('rev-month').textContent = fmt(data.month);
          document.getElementById('rev-today').textContent = fmt(data.today);
        }catch(e){ console.log('Revenue load failed', e); }
      }
      loadRevenue();
      setInterval(loadRevenue, 60000);
      

      function escapeHtml(value){
        return String(value || '').replace(/[&<>"']/g, function(char){
          return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[char];
        });
      }

      // Load and display blog posts in the table
      async function loadBlogPosts() {
        const tableBody = document.getElementById('blog-posts-table');

        if (!tableBody) return;

        tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #6b7280; padding: 20px;">Laden...</td></tr>';

        let blogPosts = [];
        try {
          const resp = await fetch('/api/blogs', { credentials: 'same-origin' });
          if (resp.status === 401) {
            window.location.href = '/personeel';
            return;
          }
          if (resp.ok) {
            const payload = await resp.json().catch(() => ({}));
            if (Array.isArray(payload?.data)) {
              blogPosts = payload.data;
            }
          }
        } catch (_err) {
          // Val later terug op localStorage
        }

        if (!blogPosts.length) {
          try {
            const stored = JSON.parse(localStorage.getItem('vitalora_blog_posts') || '[]');
            if (Array.isArray(stored) && stored.length) {
              blogPosts = stored;
            }
          } catch (_) {}
        }

        tableBody.innerHTML = '';

        if (!blogPosts.length) {
          tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #6b7280; padding: 20px;">Geen blog posts gevonden</td></tr>';
          return;
        }

          blogPosts.forEach(function(post) {
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            row.onclick = function() {
              window.open('/blog-editor.html?edit=' + encodeURIComponent(post.id), '_blank');
            };

            const statusMap = {
              published: {label:'Gepubliceerd', bg:'#10b981'},
              draft: {label:'Concept', bg:'#6b7280'},
              scheduled: {label:'Ingepland', bg:'#f59e0b'},
              offline: {label:'Offline', bg:'#ef4444'}
            };
            const meta = statusMap[post.status] || statusMap.published;
            const safeTitle = escapeHtml(post.title || 'Zonder titel');

            row.innerHTML = `
            <td style="padding: 12px 10px; border-bottom: 1px solid #eef2f7; color: #333333;">${safeTitle}</td>
            <td style="padding: 12px 10px; border-bottom: 1px solid #eef2f7; color: #333333;">
              <span style="background: ${meta.bg}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                ${meta.label}
              </span>
            </td>
            <td style="padding: 12px 10px; border-bottom: 1px solid #eef2f7; text-align:right; white-space:nowrap;">
              <button class="view-post" aria-label="Bekijken" title="Bekijken" style="background:transparent;border:0;color:#3A9AEA;cursor:pointer;padding:6px;border-radius:6px;margin-right:6px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 .001 6.001A3 3 0 0 0 12 9z"/>
                </svg>
              </button>
              <button class="delete-post" aria-label="Verwijderen" title="Verwijderen" style="background:transparent;border:0;color:#ef4444;cursor:pointer;padding:6px;border-radius:6px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M9 3h6a1 1 0 0 1 1 1v1h5v2h-1v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7H3V5h5V4a1 1 0 0 1 1-1zm1 2v0h4V5h-4zM6 7v12h12V7H6zm4 2h2v8h-2V9zm-4 0h2v8H6V9zm10 0h-2v8h2V9z"/>
                </svg>
              </button>
            </td>
          `;

            const del = row.querySelector('.delete-post');
            if (del) {
              del.addEventListener('click', async function(ev){
                ev.stopPropagation();
                if (!confirm('Weet je zeker dat je deze blog wilt verwijderen?')) return;
                let apiRemoved = false;
                try {
                  const delResp = await fetch(`/api/blogs?id=${encodeURIComponent(post.id)}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                  });
                  if (delResp.status === 401) {
                    window.location.href = '/personeel';
                    return;
                  }
                  if (delResp.ok) {
                    apiRemoved = true;
                  }
                } catch (_) {
                  // laat fallback hierna lopen
                }

                try {
                  const stored = JSON.parse(localStorage.getItem('vitalora_blog_posts') || '[]');
                  const filtered = stored.filter(p => String(p.id) !== String(post.id));
                  localStorage.setItem('vitalora_blog_posts', JSON.stringify(filtered));
                } catch (_) {}

                if (!apiRemoved) {
                  alert('Server verwijdering is mogelijk mislukt, maar lokale kopie is bijgewerkt.');
                }
                await loadBlogPosts();
              });
            }

            const viewBtn = row.querySelector('.view-post');
            if (viewBtn) {
              viewBtn.addEventListener('click', function(ev){
                ev.stopPropagation();
                const slug = post.slug || '';
                if (!slug) {
                  window.open('/blog-editor.html?edit=' + encodeURIComponent(post.id), '_blank');
                  return;
                }
                const status = post.status || 'published';
                const url = status === 'published' ? ('/' + encodeURIComponent(slug)) : ('/post.html?slug=' + encodeURIComponent(slug));
                window.open(url, '_blank');
              });
            }

            tableBody.appendChild(row);
          });
        } catch (error) {
          const message = error && error.message ? error.message : 'Onbekende fout';
          tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #ef4444; padding: 20px;">Fout bij laden: ' + escapeHtml(message) + '</td></tr>';
        }
      }

// No extra actions here; only listing and create button per verzoek
      // No extra actions here; only listing and create button per verzoek
      
      // Load blog posts when page loads
      loadBlogPosts();
      
      // Reload blog posts every 5 seconds to catch new publications
      setInterval(loadBlogPosts, 5000);
    })();
  </script>
</body>
</html>
