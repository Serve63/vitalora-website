<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hormonaal in Balans - Les</title>
    <link rel="stylesheet" href="/dashboard-styles.css">
    <link rel="stylesheet" href="/assets/css/header.css?v=12">
    <link rel="stylesheet" href="/assets/css/fonts.css?v=1">
    <link rel="stylesheet" href="/assets/css/footer.css?v=1">
</head>
<body>
    <div data-include="site-header"></div>
    <script defer src="/assets/js/header.js?v=7"></script>

    <main class="lesson-page" data-course="de-juiste-balans">
        <div class="container">
            <nav class="breadcrumb">
                <a href="/academy">Academy</a> · 
                <a href="index.html" id="crumbTitle">Hormonaal in Balans</a> · 
                <span id="lessonTitle">Les</span>
            </nav>

            <article class="lesson-content">
                <header class="lesson-header">
                    <h1 id="lessonTitle">Les</h1>
                </header>

                <div id="lessonBody" class="lesson-body">
                    <!-- Lesson content will be loaded here -->
                </div>

                <footer class="lesson-footer">
                    <div class="lesson-navigation">
                        <a id="prevLesson" href="#" class="nav-btn prev-btn" style="display: none;">← Vorige les</a>
                        <button id="markDoneBtn" class="mark-done-btn">Markeer als voltooid</button>
                        <a id="nextLesson" href="#" class="nav-btn next-btn" style="display: none;">Volgende les →</a>
                    </div>
                </footer>
            </article>
        </div>
    </main>

    <div data-include="site-footer"></div>

    <script src="/dashboard-script.js"></script>
    <script>
        /* === SCOPE: djb-lesson-loader === */
        (function(){
          const $ = (s,r=document)=>r.querySelector(s);
          const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
          const once = (fn)=>{ let ran=false; return (...a)=>{ if(ran) return; ran=true; fn(...a);} };

          function courseBase(){ // e.g. /academy/de-juiste-balans/
            return location.pathname.replace(/[^/]+$/, '');
          }
          async function loadJSON(rel){
            const url = courseBase() + rel; const r = await fetch(url, {cache:'no-cache'});
            if(!r.ok) throw new Error(url); return r.json();
          }
          async function loadHTML(rel){
            const url = courseBase() + rel; const r = await fetch(url, {cache:'no-cache'});
            if(!r.ok) throw new Error(url); return r.text();
          }
          function storageKey(course){ return `academy:${course}:done`; }

          document.addEventListener('DOMContentLoaded', async () => {
            // OVERVIEW
            const ov = $('.course-overview');
            if (ov){
              const course = ov.getAttribute('data-course') || 'de-juiste-balans';
              try{
                const lessons = await loadJSON('lessons.json');
                const done = new Set(JSON.parse(localStorage.getItem(storageKey(course)) || '[]'));
                const list = $('#lessonsList');
                list.innerHTML = lessons.map((l,i)=>`
                  <a class="lesson-item" href="lesson.html?l=${encodeURIComponent(l.slug)}">
                    <strong>${i+1}. ${l.title}</strong>
                    ${done.has(l.slug) ? '<span class="badge-done">Voltooid</span>' : ''}
                    <div class="meta">${l.desc||''}</div>
                  </a>
                `).join('');
              }catch(e){ console.error('Lessons JSON load failed', e); }
              return;
            }

            // LESSON PAGE
            const lp = $('.lesson-page');
            if (lp){
              const course = lp.getAttribute('data-course') || 'de-juiste-balans';
              const url = new URL(location.href);
              const slug = url.searchParams.get('l');
              if(!slug){ location.href = './'; return; }

              try{
                const lessons = await loadJSON('lessons.json');
                const idx = lessons.findIndex(x=>x.slug===slug);
                if(idx===-1){ location.href = './'; return; }

                const lesson = lessons[idx];
                $('#lessonTitle').textContent = lesson.title;
                $('#crumbTitle').textContent = lesson.title;
                $('#lessonBody').innerHTML = await loadHTML(lesson.file);

                const prev = $('#prevLesson'), next = $('#nextLesson');
                if(idx>0){ prev.href = `lesson.html?l=${encodeURIComponent(lessons[idx-1].slug)}`; prev.removeAttribute('aria-disabled'); }
                if(idx<lessons.length-1){ next.href = `lesson.html?l=${encodeURIComponent(lessons[idx+1].slug)}`; next.removeAttribute('aria-disabled'); }

                const key = storageKey(course);
                const done = new Set(JSON.parse(localStorage.getItem(key) || '[]'));
                const btn = $('#markDoneBtn');
                function render(){ btn.textContent = done.has(slug) ? 'Voltooid ✔' : 'Markeer als voltooid'; }
                btn.addEventListener('click', ()=>{
                  if(done.has(slug)) done.delete(slug); else done.add(slug);
                  localStorage.setItem(key, JSON.stringify([...done])); render();
                });
                render();
              }catch(e){ console.error('Lesson render failed', e); }
            }
          });
        })();
    </script>
</body>
</html>
