<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog Editor - Vitalora</title>
  <link rel="stylesheet" href="styles.css?v=2" />
  <link rel="stylesheet" href="/assets/css/header.css?v=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/fonts.css?v=12">
  <style>
    :root{--brand:#3A9AEA;--ink:#0f172a;--muted:#64748b}
    body{background:#f3f6fb; margin: 0; font-family: 'Quicksand', sans-serif;}
    
    .editor-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .editor-header {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .editor-title {
      font-size: 28px;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 8px 0;
    }
    
    .editor-subtitle {
      color: #6b7280;
      font-size: 16px;
      margin: 0;
    }
    
    .editor-form {
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .form-group {
      margin-bottom: 24px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      font-family: inherit;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-row {
      display: flex;
      gap: 16px;
    }
    
    .form-row .form-group {
      flex: 1;
    }
    
    .editor-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 16px;
      background: #f9fafb;
      border: 1px solid #d1d5db;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
    }
    
    .toolbar-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.2s ease;
    }
    
    .toolbar-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }
    
    .toolbar-btn.active {
      background: #10b981;
      color: white;
    }
    
    .editor-content {
      width: 100%;
      min-height: 400px;
      padding: 20px;
      border: 1px solid #d1d5db;
      border-radius: 0 0 8px 8px;
      font-family: inherit;
      font-size: 16px;
      line-height: 1.6;
      box-sizing: border-box;
      background: white;
      outline: none;
      color: #333333 !important;
    }
    
    .editor-content * {
      color: inherit !important;
    }
    
    .editor-content a {
      color: #3b82f6 !important;
      text-decoration: underline;
    }
    
    .editor-content blockquote {
      background: #2954B4;
      color: white !important;
      padding: 16px 20px;
      margin: 16px 0;
      border-radius: 8px;
      border-left: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      font-style: normal;
      position: relative;
    }
    
    .editor-content blockquote * {
      color: white !important;
    }
    
    .editor-content blockquote:before {
      content: '"';
      font-size: 24px;
      color: rgba(255,255,255,0.7);
      position: absolute;
      left: 8px;
      top: 8px;
    }
    
    .editor-content blockquote:after {
      content: '"';
      font-size: 24px;
      color: rgba(255,255,255,0.7);
      position: absolute;
      right: 8px;
      bottom: 8px;
    }
    
    .editor-content .summary-box {
      background: white;
      border-radius: 8px;
      margin: 16px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      border-left: 4px solid #2954B4;
    }
    
    .editor-content .summary-header {
      background: #2954B4;
      color: white !important;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    .editor-content .summary-header * { color: white !important; }
    
    .editor-content .summary-header .icon {
      width: 20px;
      height: 20px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .editor-content .summary-content {
      padding: 16px;
      color: #333333;
      min-height: 40px;
    }
    
    .editor-content .summary-content:empty:before {
      content: "In het kort...";
      color: #9ca3af;
      font-style: italic;
    }
    
    .editor-content:empty:before {
      content: attr(placeholder);
      color: #9ca3af;
      pointer-events: none;
    }
    
    .editor-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary {
      background: #10b981;
      color: white;
    }
    
    .btn-primary:hover {
      background: #059669;
    }
    
    .btn-outline {
      background: transparent;
      color: #6b7280;
      border: 1px solid #d1d5db;
    }
    
    .btn-outline:hover {
      background: #f9fafb;
    }
    .btn-danger { background:#ef4444; color:#fff; }
    .btn-danger:hover { background:#dc2626; }
    
    .image-upload-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .image-preview {
      width: 100%;
      height: 200px;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f9fafb;
      overflow: hidden;
    }
    
    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .image-placeholder {
      color: #6b7280;
      font-size: 14px;
      text-align: center;
    }
    
    .image-hint {
      color: #6b7280;
      font-size: 12px;
      margin: 8px 0 0 0;
      font-style: italic;
    }
    
    .back-link {
      color: #6b7280;
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 16px;
      display: inline-block;
    }
    
    .back-link:hover {
      color: #374151;
    }
    
    @media (max-width: 768px) {
      .editor-container {
        padding: 16px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .editor-actions {
        flex-direction: column;
      }
    }
  </style>
<link rel="icon" type="image/webp" href="/assets/images/vitalora logo.webp">
<link rel="shortcut icon" type="image/webp" href="/assets/images/vitalora logo.webp">
</head>
<body>
  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="header-inner">
      <a class="logo" href="/">
        <span class="logo-text">Vitalora.nl</span>
      </a>
      
      <div class="header-buttons">
        <!-- Header buttons removed for editor -->
      </div>
    </div>
  </header>

  <div class="editor-container">
    <a href="/personeel-dashboard" class="back-link">‚Üê Terug naar dashboard</a>
    
    <div class="editor-header">
      <h1 class="editor-title">Blog Inhoud</h1>
      <p class="editor-subtitle">Maak een nieuwe blog post</p>
    </div>
    
    <form class="editor-form">
      <div class="form-group">
        <label class="form-label">Titel</label>
        <input type="text" class="form-input" id="blog-title" placeholder="Voer blog titel in">
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">URL</label>
          <input type="text" class="form-input" id="blog-slug" placeholder="blog-url">
          <small id="slug-hint" style="display:block;color:#64748b;margin-top:4px">Uniek, alleen letters/cijfers/koppelteken</small>
        </div>
        <div class="form-group">
          <label class="form-label">Publicatiedatum</label>
          <input type="date" class="form-input" id="blog-date" placeholder="jjjj-mm-dd">
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Meta Titel</label>
        <input type="text" class="form-input" id="blog-meta-title" placeholder="SEO titel voor zoekmachines">
      </div>
      
      <div class="form-group">
        <label class="form-label">Meta Beschrijving</label>
        <textarea class="form-input" id="blog-meta-description" rows="3" placeholder="SEO beschrijving voor zoekmachines (max 160 karakters)"></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Header Afbeelding</label>
        <div class="image-upload-section">
          <div class="image-preview" id="image-preview">
            <div class="image-placeholder">
              <span>Geen afbeelding geselecteerd</span>
            </div>
          </div>
          <button type="button" class="btn btn-outline" id="upload-image-btn">
            üì∑ Afbeelding uploaden
          </button>
          <input type="file" id="image-input" accept="image/*" style="display: none;">
          <p class="image-hint">Aanbevolen formaat: 800x450px</p>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Inhoud</label>
        <div class="editor-toolbar">
          <button type="button" class="toolbar-btn" title="Vet">B</button>
          <button type="button" class="toolbar-btn" title="Cursief">I</button>
          <button type="button" class="toolbar-btn" title="Onderstreept">U</button>
          <button type="button" class="toolbar-btn" title="Normale Tekst">P</button>
          <button type="button" class="toolbar-btn" title="Kop 1">H1</button>
          <button type="button" class="toolbar-btn" title="Kop 2">H2</button>
          <button type="button" class="toolbar-btn" title="Kop 3">H3</button>
          <button type="button" class="toolbar-btn" title="Kop 4">H4</button>
          <button type="button" class="toolbar-btn" title="Quote">"</button>
          <button type="button" class="toolbar-btn" title="Kort">üìã</button>
          <button type="button" class="toolbar-btn" title="Afbeelding Toevoegen">üñºÔ∏è</button>
        </div>
        <div class="editor-content" id="blog-content" contenteditable="true" placeholder="Begin met het schrijven van je blog post..."></div>
      </div>
      
      <div class="editor-actions">
        <button type="button" class="btn btn-outline" id="save-draft">Concept Opslaan</button>
        <button type="button" class="btn btn-outline" id="schedule-blog">Inplannen</button>
        <button type="button" class="btn btn-primary" id="publish-blog">Publiceren</button>
        <button type="button" class="btn btn-secondary" id="preview-blog">Preview</button>
        <button type="button" class="btn btn-danger" id="delete-blog" style="display:none;">Verwijderen</button>
      </div>
    </form>
  </div>

  <script>
    (async function(){
      async function confirmStaffAccess(){
        try {
          const resp = await fetch('/api/staff/guard', { credentials: 'same-origin' });
          if (!resp.ok) throw new Error('Unauthorized');
          return resp.json();
        } catch (_) {
          window.location.href = '/personeel';
          throw new Error('redirecting');
        }
      }

      try {
        await confirmStaffAccess();
      } catch (_) {
        return;
      }
      
      // Get elements
      const blogTitle = document.getElementById('blog-title');
      const blogSlug = document.getElementById('blog-slug');
      const slugHint = document.getElementById('slug-hint');
      const blogMetaTitle = document.getElementById('blog-meta-title');
      const blogMetaDescription = document.getElementById('blog-meta-description');
      const blogContent = document.getElementById('blog-content');
      const blogDate = document.getElementById('blog-date');
      const saveDraftBtn = document.getElementById('save-draft');
      const scheduleBtn = document.getElementById('schedule-blog');
      const publishBtn = document.getElementById('publish-blog');
      const deleteBtn = document.getElementById('delete-blog');
      
      // Image upload elements
      const imagePreview = document.getElementById('image-preview');
      const uploadImageBtn = document.getElementById('upload-image-btn');
      const imageInput = document.getElementById('image-input');
      
      // Check if we're editing an existing post
      const urlParams = new URLSearchParams(window.location.search);
      let editId = urlParams.get('edit');
      let currentPost = null;
      let blogPostsCache = [];
      const API_BASE = '/api/blogs';

      async function fetchJson(url, options = {}) {
        const init = { ...options };
        init.headers = init.headers ? { ...init.headers } : {};
        if (init.body && !(init.body instanceof FormData)) {
          init.headers['Content-Type'] = 'application/json';
        }
        if (!init.credentials) {
          init.credentials = 'same-origin';
        }
        const response = await fetch(url, init);
        const text = await response.text();
        let data = null;
        if (text) {
          try { data = JSON.parse(text); } catch (_) { data = null; }
        }
        if (!response.ok) {
          const message = (data && data.error) || response.statusText || 'Onbekende fout';
          const error = new Error(message);
          error.status = response.status;
          error.details = data;
          if (response.status === 401) {
            window.location.href = '/personeel';
          }
          throw error;
        }
        return data;
      }

      async function refreshCache() {
        try {
          const res = await fetchJson(API_BASE);
          blogPostsCache = Array.isArray(res?.data) ? res.data : [];
          try {
            if (typeof localStorage !== 'undefined') {
              localStorage.setItem('vitalora_blog_posts', JSON.stringify(blogPostsCache));
            }
          } catch (_) {}
        } catch (error) {
          blogPostsCache = [];
          console.error('Kon blogposts niet laden', error);
          try {
            if (typeof localStorage !== 'undefined') {
              localStorage.removeItem('vitalora_blog_posts');
            }
          } catch (_) {}
        }
        return blogPostsCache;
      }

      async function fetchPostById(id) {
        if (!id) return null;
        const res = await fetchJson(`${API_BASE}?id=${encodeURIComponent(id)}`);
        return res?.data || null;
      }

      async function upsertPost(payload) {
        if (editId) {
          const res = await fetchJson(`${API_BASE}?id=${encodeURIComponent(editId)}`, {
            method: 'PUT',
            body: JSON.stringify(payload)
          });
          return res?.data || null;
        }
        const res = await fetchJson(API_BASE, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        return res?.data || null;
      }

      async function removePost(id) {
        if (!id) return;
        await fetchJson(`${API_BASE}?id=${encodeURIComponent(id)}`, { method: 'DELETE' });
      }

      function updateScheduleButtonLabel(status) {
        if (!scheduleBtn) return;
        if (status === 'published') {
          scheduleBtn.textContent = 'Offline zetten';
        } else if (status === 'offline') {
          scheduleBtn.textContent = 'Online zetten';
        } else {
          scheduleBtn.textContent = 'Inplannen';
        }
      }

      function handleError(prefix, error) {
        console.error(prefix, error);
        const message = error && error.message ? error.message : 'Onbekende fout';
        alert(prefix + ': ' + message);
      }

      // --- Editor UX helpers for "In het kort..." box ---
      function normalizeSummaryHeadersInEditor() {
        try {
          document.querySelectorAll('.summary-header').forEach(function(h){
            const icon = h.querySelector('.icon');
            h.innerHTML = '';
            const iconEl = document.createElement('div');
            iconEl.className = 'icon';
            iconEl.textContent = 'üìã';
            h.appendChild(iconEl);
            h.appendChild(document.createTextNode(' In het kort...'));
          });
        } catch(_) {}
      }

      function ensureParagraphAfterSummaryBoxes() {
        document.querySelectorAll('.summary-box').forEach(function(box){
          const next = box.nextSibling && box.nextSibling.nodeType === 1 ? box.nextSibling : box.nextElementSibling;
          if (!next || (next.tagName !== 'P' && !next.classList?.contains('summary-box'))) {
            const p = document.createElement('p');
            p.innerHTML = '<br>';
            box.insertAdjacentElement('afterend', p);
          }
        });
      }

      function placeCaret(el){
        try {
          const range = document.createRange();
          range.selectNodeContents(el);
          range.collapse(true);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        } catch(_) {}
      }

      // On load, normalize label and make sure you can click below the box
      normalizeSummaryHeadersInEditor();
      ensureParagraphAfterSummaryBoxes();

      // Hitting Enter inside summary-content moves caret below the box (Shift+Enter = nieuwe regel)
      blogContent.addEventListener('keydown', function(e){
        const target = e.target;
        if (target && target.classList && target.classList.contains('summary-content')) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            const box = target.closest('.summary-box');
            if (!box) return;
            const p = document.createElement('p');
            p.innerHTML = '<br>';
            box.insertAdjacentElement('afterend', p);
            placeCaret(p);
          }
        }
      });
      
      await refreshCache();
      updateSlugHint();

      if (editId) {
        try {
          const post = await fetchPostById(editId);
          if (!post) {
            alert('Blogpost niet gevonden');
            window.location.href = '/personeel-dashboard';
            return;
          }

          currentPost = post;
          blogTitle.value = post.title || '';
          blogSlug.value = post.slug || '';
          blogMetaTitle.value = post.metaTitle || '';
          blogMetaDescription.value = post.metaDescription || '';
          blogContent.innerHTML = post.content || '';
          if (blogDate) {
            var d = post.publishedDate || post.publishDate || '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
              blogDate.value = d;
            } else {
              blogDate.value = '';
            }
          }

          if (post.featuredImage) {
            const img = document.createElement('img');
            img.src = post.featuredImage;
            img.alt = 'Header afbeelding';
            imagePreview.innerHTML = '';
            imagePreview.appendChild(img);
          }

          document.title = 'Bewerk: ' + post.title + ' - Vitalora';
          document.querySelector('.editor-title').textContent = 'Blog Bewerken';
          document.querySelector('.editor-subtitle').textContent = 'Bewerk je bestaande blog post';
          publishBtn.textContent = 'Bijwerken';
          saveDraftBtn.textContent = 'Als concept opslaan';
          deleteBtn.style.display = 'inline-block';
          updateScheduleButtonLabel(post.status);
          updateSlugHint();
        } catch (error) {
          handleError('Kon blogpost niet laden', error);
          window.location.href = '/personeel-dashboard';
          return;
        }
      }
      
      // Handle clicking outside summary content to exit
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.summary-content')) {
          // Remove focus from any summary content
          const summaryContents = document.querySelectorAll('.summary-content');
          summaryContents.forEach(content => {
            if (content === document.activeElement) {
              content.blur();
            }
          });
        }
      });
      
      function normalizeSlug(input){
        return (input||'').toLowerCase().replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');
      }

      function isUniqueSlug(slug, ignoreId){
        if (!slug) return true;
        return !blogPostsCache.some(function(post){
          return post.slug === slug && String(post.id) !== String(ignoreId || '');
        });
      }

      function updateSlugHint(){
        if (!slugHint) return;
        const normalized = normalizeSlug(blogSlug.value);
        if (blogSlug.value !== normalized) {
          blogSlug.value = normalized;
        }
        const ok = isUniqueSlug(blogSlug.value, editId);
        slugHint.style.color = ok ? '#64748b' : '#ef4444';
        slugHint.textContent = ok ? 'Uniek, alleen letters/cijfers/koppelteken' : 'Slug is al in gebruik';
      }

      blogTitle.addEventListener('blur', function(){
        if(!blogSlug.value.trim()){
          blogSlug.value = normalizeSlug(blogTitle.value);
        }
        updateSlugHint();
      });

      blogSlug.addEventListener('input', function(){
        updateSlugHint();
      });

      // Toolbar functionality
      document.querySelectorAll('.toolbar-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const command = this.title.toLowerCase();
          blogContent.focus();
          
          switch(command) {
            case 'vet':
              document.execCommand('bold', false, null);
              break;
            case 'cursief':
              document.execCommand('italic', false, null);
              break;
            case 'onderstreept':
              document.execCommand('underline', false, null);
              break;
            case 'normale tekst':
              document.execCommand('removeFormat', false, null);
              break;
            case 'kop 1':
              document.execCommand('formatBlock', false, 'h1');
              break;
            case 'kop 2':
              document.execCommand('formatBlock', false, 'h2');
              break;
            case 'kop 3':
              document.execCommand('formatBlock', false, 'h3');
              break;
            case 'kop 4':
              document.execCommand('formatBlock', false, 'h4');
              break;
            case 'quote':
              if (document.queryCommandState('formatBlock') && document.queryCommandValue('formatBlock') === 'blockquote') {
                document.execCommand('formatBlock', false, 'div');
              } else {
                document.execCommand('formatBlock', false, 'blockquote');
              }
              break;
            case 'kort':
              let summaryTitle = prompt('Voer titel in voor "Kort" sectie:', 'In het kort...');
              if (!summaryTitle) summaryTitle = 'In het kort...';
              {
                const summaryHTML = `
                  <div class="summary-box">
                    <div class="summary-header">
                      <div class="icon">üìã</div>
                      ${summaryTitle}
                    </div>
                    <div class="summary-content" contenteditable="true"></div>
                  </div>`;
                document.execCommand('insertHTML', false, summaryHTML);
                // After insert: normalize label and add paragraph after
                setTimeout(function(){
                  try {
                    normalizeSummaryHeadersInEditor();
                    ensureParagraphAfterSummaryBoxes();
                    const lastBox = blogContent.querySelector('.summary-box:last-of-type');
                    if (lastBox && lastBox.nextElementSibling) blogContent.focus();
                  } catch(_){}
                }, 0);
              }
              break;
            case 'afbeelding toevoegen':
              const fileInput = document.createElement('input');
              fileInput.type = 'file';
              fileInput.accept = 'image/*';
              fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                    document.execCommand('insertHTML', false, `<img src="${e.target.result}" alt="Afbeelding" style="max-width: 100%; height: auto;">`);
                  };
                  reader.readAsDataURL(file);
                }
              };
              fileInput.click();
              break;
          }
        });
      });
      
      // Image upload functionality
      uploadImageBtn.addEventListener('click', function() {
        imageInput.click();
      });
      
      imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.alt = 'Header afbeelding';
            imagePreview.innerHTML = '';
            imagePreview.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      });
      
      function getFeaturedImageFromPreview() {
        const previewImg = imagePreview.querySelector('img');
        return previewImg ? previewImg.src : null;
      }

      function buildBasePayload(options = {}) {
        const requireContent = options && options.requireContent === true;
        const title = blogTitle.value.trim();
        let slugValue = blogSlug.value.trim();
        const metaTitle = blogMetaTitle.value.trim();
        const metaDescription = blogMetaDescription.value.trim();
        const content = blogContent.innerHTML;
        let featuredImage = getFeaturedImageFromPreview();

        if (!title) {
          alert('Vul de titel in');
          return null;
        }

        if (!slugValue) {
          slugValue = normalizeSlug(title);
        } else {
          slugValue = normalizeSlug(slugValue);
        }

        blogSlug.value = slugValue;

        if (!slugValue) {
          alert('Slug mag niet leeg zijn');
          updateSlugHint();
          return null;
        }

        if (!isUniqueSlug(slugValue, editId)) {
          alert('Slug is al in gebruik');
          updateSlugHint();
          return null;
        }

        if (requireContent && !content) {
          alert('Vul de inhoud in');
          return null;
        }

        if (!featuredImage && currentPost && currentPost.featuredImage) {
          featuredImage = currentPost.featuredImage;
        }

        const plainWords = content
          .replace(/<[^>]*>/g, ' ')
          .split(/\s+/)
          .filter(Boolean);
        const readTime = Math.max(3, Math.ceil(plainWords.length / 200));

        updateSlugHint();

        return {
          title,
          slug: slugValue,
          metaTitle,
          metaDescription,
          content,
          featuredImage,
          readTime
        };
      }

      // Save as draft (create or update)
      saveDraftBtn.addEventListener('click', async function() {
        const base = buildBasePayload();
        if (!base) return;

        const payload = {
          ...base,
          status: 'draft',
          publishDate: (blogDate && blogDate.value) ? blogDate.value : (currentPost?.publishDate || null),
          publishedDate: currentPost?.publishedDate || null
        };

        try {
          const saved = await upsertPost(payload);
          if (!saved) throw new Error('Geen antwoord van de server');
          currentPost = saved;
          editId = String(saved.id);
          deleteBtn.style.display = 'inline-block';
          updateScheduleButtonLabel(saved.status);
          await refreshCache();
          updateSlugHint();
          alert('Concept succesvol opgeslagen!');
          window.location.href = '/personeel-dashboard';
        } catch (error) {
          handleError('Opslaan mislukt', error);
        }
      });

      // Schedule or toggle offline/online in edit mode
      scheduleBtn.addEventListener('click', async function() {
        const base = buildBasePayload({ requireContent: true });
        if (!base) return;

        const buttonText = this.textContent || '';

        if (editId && (buttonText.includes('Offline') || buttonText.includes('Online'))) {
          const nextStatus = buttonText.includes('Offline') ? 'offline' : 'published';
          const payload = {
            ...base,
            status: nextStatus,
            publishDate: currentPost?.publishDate || null,
            publishedDate: currentPost?.publishedDate || null
          };
          try {
            const saved = await upsertPost(payload);
            if (!saved) throw new Error('Geen antwoord van de server');
            currentPost = saved;
            editId = String(saved.id);
            updateScheduleButtonLabel(saved.status);
            await refreshCache();
            updateSlugHint();
            alert(nextStatus === 'offline' ? 'Blog offline gezet' : 'Blog online gezet');
            window.location.href = '/personeel-dashboard';
          } catch (error) {
            handleError('Status bijwerken mislukt', error);
          }
          return;
        }

        const scheduleDate = (blogDate && blogDate.value) ? blogDate.value : prompt('Voer datum (YYYY-MM-DD):');
        if (!scheduleDate) return;

        const payload = {
          ...base,
          status: 'scheduled',
          publishDate: scheduleDate,
          publishedDate: null
        };

        try {
          const saved = await upsertPost(payload);
          if (!saved) throw new Error('Geen antwoord van de server');
          currentPost = saved;
          editId = String(saved.id);
          deleteBtn.style.display = 'inline-block';
          updateScheduleButtonLabel(saved.status);
          await refreshCache();
          updateSlugHint();
          alert('Blog succesvol ingepland!');
          window.location.href = '/personeel-dashboard';
        } catch (error) {
          handleError('Inplannen mislukt', error);
        }
      });

      // Publish blog
      publishBtn.addEventListener('click', async function() {
        const base = buildBasePayload({ requireContent: true });
        if (!base) return;

        if (!confirm('Weet je zeker dat je deze blog post wilt publiceren?')) {
          return;
        }

        const wasExisting = Boolean(editId);
        let publishedDate = (blogDate && blogDate.value) ? blogDate.value : null;
        if (!publishedDate) {
          if (currentPost && currentPost.publishedDate) {
            publishedDate = currentPost.publishedDate;
          } else {
            publishedDate = new Date().toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' });
          }
        }

        const payload = {
          ...base,
          status: 'published',
          publishDate: null,
          publishedDate
        };

        try {
          const saved = await upsertPost(payload);
          if (!saved) throw new Error('Geen antwoord van de server');
          currentPost = saved;
          editId = String(saved.id);
          deleteBtn.style.display = 'inline-block';
          updateScheduleButtonLabel(saved.status);
          await refreshCache();
          updateSlugHint();
          alert(wasExisting ? 'Blog succesvol bijgewerkt!' : 'Blog succesvol gepubliceerd!');
          window.location.href = '/personeel-dashboard';
        } catch (error) {
          handleError('Publiceren mislukt', error);
        }
      });

      // Delete blog
      deleteBtn.addEventListener('click', async function(){
        if(!editId){ return; }
        if(!confirm('Weet je zeker dat je deze blog wilt verwijderen?')) return;
        try {
          await removePost(editId);
          await refreshCache();
          alert('Blog verwijderd');
          window.location.href = '/personeel-dashboard';
        } catch (error) {
          handleError('Verwijderen mislukt', error);
        }
      });

      // Preview opens post.html with current slug in new tab
      const previewBtn = document.getElementById('preview-blog');
      if (previewBtn) {
        previewBtn.addEventListener('click', async function(){
          const slug = normalizeSlug(blogSlug.value || blogTitle.value);
          if(!slug){ alert('Vul eerst titel of slug in'); return; }
          blogSlug.value = slug;

          const base = buildBasePayload();
          if (!base) return;

          const payload = {
            ...base,
            slug,
            status: currentPost?.status || 'draft',
            publishDate: (blogDate && blogDate.value) ? blogDate.value : (currentPost?.publishDate || null),
            publishedDate: currentPost?.publishedDate || null
          };

          try {
            const saved = await upsertPost(payload);
            if (!saved) throw new Error('Geen antwoord van de server');
            currentPost = saved;
            editId = String(saved.id);
            deleteBtn.style.display = 'inline-block';
            updateScheduleButtonLabel(saved.status);
            await refreshCache();
            updateSlugHint();
          } catch (error) {
            handleError('Opslaan voor preview mislukt', error);
            return;
          }

          window.open('/post.html?slug=' + encodeURIComponent(slug), '_blank');
        });
      }

    })();
  </script>
</body>
</html>
