<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog Editor - Vitalora</title>
  <link rel="stylesheet" href="styles.css?v=2" />
  <link rel="stylesheet" href="/assets/css/header.css?v=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/fonts.css?v=12">
  <style>
    :root{--brand:#3A9AEA;--ink:#0f172a;--muted:#64748b}
    body{background:#f3f6fb; margin: 0; font-family: 'Quicksand', sans-serif;}
    
    .editor-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .editor-header {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .editor-title {
      font-size: 28px;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 8px 0;
    }
    
    .editor-subtitle {
      color: #6b7280;
      font-size: 16px;
      margin: 0;
    }
    
    .editor-form {
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .form-group {
      margin-bottom: 24px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      font-family: inherit;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-row {
      display: flex;
      gap: 16px;
    }
    
    .form-row .form-group {
      flex: 1;
    }
    
    .editor-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 16px;
      background: #f9fafb;
      border: 1px solid #d1d5db;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
    }
    
    .toolbar-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.2s ease;
    }
    
    .toolbar-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }
    
    .toolbar-btn.active {
      background: #10b981;
      color: white;
    }
    
    .editor-content {
      width: 100%;
      min-height: 400px;
      padding: 20px;
      border: 1px solid #d1d5db;
      border-radius: 0 0 8px 8px;
      font-family: inherit;
      font-size: 16px;
      line-height: 1.6;
      box-sizing: border-box;
      background: white;
      outline: none;
      color: #333333 !important;
    }
    
    .editor-content * {
      color: inherit !important;
    }
    
    .editor-content a {
      color: #3b82f6 !important;
      text-decoration: underline;
    }
    
    .editor-content blockquote {
      background: #2954B4;
      color: white !important;
      padding: 16px 20px;
      margin: 16px 0;
      border-radius: 8px;
      border-left: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      font-style: normal;
      position: relative;
    }
    
    .editor-content blockquote * {
      color: white !important;
    }
    
    .editor-content blockquote:before {
      content: '"';
      font-size: 24px;
      color: rgba(255,255,255,0.7);
      position: absolute;
      left: 8px;
      top: 8px;
    }
    
    .editor-content blockquote:after {
      content: '"';
      font-size: 24px;
      color: rgba(255,255,255,0.7);
      position: absolute;
      right: 8px;
      bottom: 8px;
    }
    
    .editor-content .summary-box {
      background: white;
      border-radius: 8px;
      margin: 16px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      border-left: 4px solid #2954B4;
    }
    
    .editor-content .summary-header {
      background: #2954B4;
      color: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    
    .editor-content .summary-header .icon {
      width: 20px;
      height: 20px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .editor-content .summary-content {
      padding: 16px;
      color: #333333;
      min-height: 40px;
    }
    
    .editor-content .summary-content:empty:before {
      content: "Even Kort Uitgelegd...";
      color: #9ca3af;
      font-style: italic;
    }
    
    .editor-content:empty:before {
      content: attr(placeholder);
      color: #9ca3af;
      pointer-events: none;
    }
    
    .editor-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary {
      background: #10b981;
      color: white;
    }
    
    .btn-primary:hover {
      background: #059669;
    }
    
    .btn-outline {
      background: transparent;
      color: #6b7280;
      border: 1px solid #d1d5db;
    }
    
    .btn-outline:hover {
      background: #f9fafb;
    }
    .btn-danger { background:#ef4444; color:#fff; }
    .btn-danger:hover { background:#dc2626; }
    
    .image-upload-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .image-preview {
      width: 100%;
      height: 200px;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f9fafb;
      overflow: hidden;
    }
    
    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .image-placeholder {
      color: #6b7280;
      font-size: 14px;
      text-align: center;
    }
    
    .image-hint {
      color: #6b7280;
      font-size: 12px;
      margin: 8px 0 0 0;
      font-style: italic;
    }
    
    .back-link {
      color: #6b7280;
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 16px;
      display: inline-block;
    }
    
    .back-link:hover {
      color: #374151;
    }
    
    @media (max-width: 768px) {
      .editor-container {
        padding: 16px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .editor-actions {
        flex-direction: column;
      }
    }
  </style>
<link rel="icon" type="image/webp" href="/assets/images/vitalora logo.webp">
<link rel="shortcut icon" type="image/webp" href="/assets/images/vitalora logo.webp">
</head>
<body>
  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="header-inner">
      <a class="logo" href="/">
        <span class="logo-text">Vitalora.nl</span>
      </a>
      
      <div class="header-buttons">
        <!-- Header buttons removed for editor -->
      </div>
    </div>
  </header>

  <div class="editor-container">
    <a href="/personeel-dashboard" class="back-link">‚Üê Terug naar dashboard</a>
    
    <div class="editor-header">
      <h1 class="editor-title">Blog Inhoud</h1>
      <p class="editor-subtitle">Maak een nieuwe blog post</p>
    </div>
    
    <form class="editor-form">
      <div class="form-group">
        <label class="form-label">Titel</label>
        <input type="text" class="form-input" id="blog-title" placeholder="Voer blog titel in">
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">URL</label>
          <input type="text" class="form-input" id="blog-slug" placeholder="blog-url">
          <small id="slug-hint" style="display:block;color:#64748b;margin-top:4px">Uniek, alleen letters/cijfers/koppelteken</small>
        </div>
        <div class="form-group">
          <label class="form-label">Revisies</label>
          <select class="form-input" id="blog-revisions">
            <option>Toon revisies</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Meta Titel</label>
        <input type="text" class="form-input" id="blog-meta-title" placeholder="SEO titel voor zoekmachines">
      </div>
      
      <div class="form-group">
        <label class="form-label">Meta Beschrijving</label>
        <textarea class="form-input" id="blog-meta-description" rows="3" placeholder="SEO beschrijving voor zoekmachines (max 160 karakters)"></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Header Afbeelding</label>
        <div class="image-upload-section">
          <div class="image-preview" id="image-preview">
            <div class="image-placeholder">
              <span>Geen afbeelding geselecteerd</span>
            </div>
          </div>
          <button type="button" class="btn btn-outline" id="upload-image-btn">
            üì∑ Afbeelding uploaden
          </button>
          <input type="file" id="image-input" accept="image/*" style="display: none;">
          <p class="image-hint">Aanbevolen formaat: 800x450px</p>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Inhoud</label>
        <div class="editor-toolbar">
          <button type="button" class="toolbar-btn" title="Vet">B</button>
          <button type="button" class="toolbar-btn" title="Cursief">I</button>
          <button type="button" class="toolbar-btn" title="Onderstreept">U</button>
          <button type="button" class="toolbar-btn" title="Normale Tekst">P</button>
          <button type="button" class="toolbar-btn" title="Kop 1">H1</button>
          <button type="button" class="toolbar-btn" title="Kop 2">H2</button>
          <button type="button" class="toolbar-btn" title="Kop 3">H3</button>
          <button type="button" class="toolbar-btn" title="Kop 4">H4</button>
          <button type="button" class="toolbar-btn" title="Quote">"</button>
          <button type="button" class="toolbar-btn" title="Kort">üìã</button>
          <button type="button" class="toolbar-btn" title="Afbeelding Toevoegen">üñºÔ∏è</button>
        </div>
        <div class="editor-content" id="blog-content" contenteditable="true" placeholder="Begin met het schrijven van je blog post..."></div>
      </div>
      
      <div class="editor-actions">
        <button type="button" class="btn btn-outline" id="save-draft">Concept Opslaan</button>
        <button type="button" class="btn btn-outline" id="schedule-blog">Inplannen</button>
        <button type="button" class="btn btn-primary" id="publish-blog">Publiceren</button>
        <button type="button" class="btn btn-secondary" id="preview-blog">Preview</button>
        <button type="button" class="btn btn-danger" id="delete-blog" style="display:none;">Verwijderen</button>
      </div>
    </form>
  </div>

  <script>
    (function(){
      // Check if user has access
      const key='staff_access_ok';
      if(localStorage.getItem(key)!=='1'){ 
        window.location.href='/personeel'; 
        return; 
      }
      
      // Get elements
      const blogTitle = document.getElementById('blog-title');
      const blogSlug = document.getElementById('blog-slug');
      const slugHint = document.getElementById('slug-hint');
      const blogMetaTitle = document.getElementById('blog-meta-title');
      const blogMetaDescription = document.getElementById('blog-meta-description');
      const blogContent = document.getElementById('blog-content');
      const saveDraftBtn = document.getElementById('save-draft');
      const scheduleBtn = document.getElementById('schedule-blog');
      const publishBtn = document.getElementById('publish-blog');
      const deleteBtn = document.getElementById('delete-blog');
      
      // Image upload elements
      const imagePreview = document.getElementById('image-preview');
      const uploadImageBtn = document.getElementById('upload-image-btn');
      const imageInput = document.getElementById('image-input');
      
      // Check if we're editing an existing post
      const urlParams = new URLSearchParams(window.location.search);
      const editId = urlParams.get('edit');
      
      if (editId) {
        // Load existing blog post for editing
        const blogPosts = JSON.parse(localStorage.getItem('vitalora_blog_posts') || '[]');
        const post = blogPosts.find(p => p.id == editId);
        
        if (post) {
          blogTitle.value = post.title;
          blogSlug.value = post.slug;
          blogMetaTitle.value = post.metaTitle;
          blogMetaDescription.value = post.metaDescription;
          blogContent.innerHTML = post.content;
          
          // Load existing image if available
          if (post.featuredImage) {
            const img = document.createElement('img');
            img.src = post.featuredImage;
            img.alt = 'Header afbeelding';
            imagePreview.innerHTML = '';
            imagePreview.appendChild(img);
          }
          
          // Update page title and actions for edit mode
          document.title = 'Bewerk: ' + post.title + ' - Vitalora';
          document.querySelector('.editor-title').textContent = 'Blog Bewerken';
          document.querySelector('.editor-subtitle').textContent = 'Bewerk je bestaande blog post';
          publishBtn.textContent = 'Bijwerken';
          saveDraftBtn.textContent = 'Als concept opslaan';
          scheduleBtn.textContent = 'Opnieuw inplannen';
          deleteBtn.style.display = 'inline-block';
          // Add/offline toggle button inline (reuse schedule button label based on status)
          if (post.status === 'published') {
            scheduleBtn.textContent = 'Offline zetten';
          } else if (post.status === 'offline') {
            scheduleBtn.textContent = 'Online zetten';
          }
        }
      }
      
      // Handle clicking outside summary content to exit
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.summary-content')) {
          // Remove focus from any summary content
          const summaryContents = document.querySelectorAll('.summary-content');
          summaryContents.forEach(content => {
            if (content === document.activeElement) {
              content.blur();
            }
          });
        }
      });
      
      function normalizeSlug(input){
        return (input||'').toLowerCase().replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');
      }

      function isUniqueSlug(slug, ignoreId){
        try {
          const posts = JSON.parse(localStorage.getItem('vitalora_blog_posts')||'[]');
          return !posts.some(p => p.slug === slug && String(p.id) !== String(ignoreId||''));
        } catch(_) { return true; }
      }

      blogTitle.addEventListener('blur', function(){
        if(!blogSlug.value.trim()){
          blogSlug.value = normalizeSlug(blogTitle.value);
        }
      });

      blogSlug.addEventListener('input', function(){
        const normalized = normalizeSlug(blogSlug.value);
        if (blogSlug.value !== normalized) blogSlug.value = normalized;
        const ok = isUniqueSlug(blogSlug.value, editId);
        slugHint.style.color = ok ? '#64748b' : '#ef4444';
        slugHint.textContent = ok ? 'Uniek, alleen letters/cijfers/koppelteken' : 'Slug is al in gebruik';
      });

      // Toolbar functionality
      document.querySelectorAll('.toolbar-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const command = this.title.toLowerCase();
          blogContent.focus();
          
          switch(command) {
            case 'vet':
              document.execCommand('bold', false, null);
              break;
            case 'cursief':
              document.execCommand('italic', false, null);
              break;
            case 'onderstreept':
              document.execCommand('underline', false, null);
              break;
            case 'normale tekst':
              document.execCommand('removeFormat', false, null);
              break;
            case 'kop 1':
              document.execCommand('formatBlock', false, 'h1');
              break;
            case 'kop 2':
              document.execCommand('formatBlock', false, 'h2');
              break;
            case 'kop 3':
              document.execCommand('formatBlock', false, 'h3');
              break;
            case 'kop 4':
              document.execCommand('formatBlock', false, 'h4');
              break;
            case 'quote':
              if (document.queryCommandState('formatBlock') && document.queryCommandValue('formatBlock') === 'blockquote') {
                document.execCommand('formatBlock', false, 'div');
              } else {
                document.execCommand('formatBlock', false, 'blockquote');
              }
              break;
            case 'kort':
              const summaryTitle = prompt('Voer titel in voor "Kort" sectie:', 'Kort');
              if (summaryTitle) {
                const summaryHTML = `
                  <div class="summary-box">
                    <div class="summary-header">
                      <div class="icon">üìã</div>
                      ${summaryTitle}
                    </div>
                    <div class="summary-content" contenteditable="true"></div>
                  </div>
                `;
                document.execCommand('insertHTML', false, summaryHTML);
              }
              break;
            case 'afbeelding toevoegen':
              const fileInput = document.createElement('input');
              fileInput.type = 'file';
              fileInput.accept = 'image/*';
              fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                    document.execCommand('insertHTML', false, `<img src="${e.target.result}" alt="Afbeelding" style="max-width: 100%; height: auto;">`);
                  };
                  reader.readAsDataURL(file);
                }
              };
              fileInput.click();
              break;
          }
        });
      });
      
      // Image upload functionality
      uploadImageBtn.addEventListener('click', function() {
        imageInput.click();
      });
      
      imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.alt = 'Header afbeelding';
            imagePreview.innerHTML = '';
            imagePreview.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      });
      
      function getFeaturedImageFromPreview() {
        const previewImg = imagePreview.querySelector('img');
        return previewImg ? previewImg.src : null;
      }

      // Save as draft (create or update)
      saveDraftBtn.addEventListener('click', function() {
        const title = blogTitle.value.trim();
        let slug = blogSlug.value.trim();
        const metaTitle = blogMetaTitle.value.trim();
        const metaDescription = blogMetaDescription.value.trim();
        const content = blogContent.innerHTML;
        let featuredImage = getFeaturedImageFromPreview();

        if (!title) {
          alert('Vul de titel in');
          return;
        }

        if (!slug) {
          slug = title.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
          blogSlug.value = slug;
        }

        let blogPosts = JSON.parse(localStorage.getItem('vitalora_blog_posts') || '[]');
        if (editId) {
          const index = blogPosts.findIndex(p => p.id == editId);
          if (index !== -1) {
            if (!featuredImage && blogPosts[index].featuredImage) {
              featuredImage = blogPosts[index].featuredImage;
            }
            blogPosts[index] = {
              ...blogPosts[index],
              title,
              slug,
              metaTitle,
              metaDescription,
              content,
              featuredImage,
              status: 'draft',
              updatedAt: new Date().toISOString()
            };
          }
        } else {
          const newPost = {
            id: Date.now(),
            title,
            slug,
            metaTitle,
            metaDescription,
            content,
            featuredImage,
            status: 'draft',
            createdAt: new Date().toISOString(),
            readTime: Math.max(3, Math.ceil(content.replace(/<[^>]*>/g, '').split(' ').length / 200))
          };
          blogPosts.unshift(newPost);
        }

        localStorage.setItem('vitalora_blog_posts', JSON.stringify(blogPosts));
        alert('Concept succesvol opgeslagen!');
        window.location.href = '/personeel-dashboard';
      });
      
      // Schedule or toggle offline/online in edit mode
      scheduleBtn.addEventListener('click', function() {
        const title = blogTitle.value.trim();
        let slug = blogSlug.value.trim();
        const metaTitle = blogMetaTitle.value.trim();
        const metaDescription = blogMetaDescription.value.trim();
        const content = blogContent.innerHTML;
        let featuredImage = getFeaturedImageFromPreview();

        if (!title || !content) {
          alert('Vul titel en inhoud in');
          return;
        }

        // If in edit mode and button says Offline/Online zetten, toggle
        if (editId && (this.textContent.includes('Offline') || this.textContent.includes('Online'))) {
          let blogPosts = JSON.parse(localStorage.getItem('vitalora_blog_posts') || '[]');
          const index = blogPosts.findIndex(p => p.id == editId);
          if (index !== -1) {
            const nextStatus = this.textContent.includes('Offline') ? 'offline' : 'published';
            blogPosts[index].status = nextStatus;
            localStorage.setItem('vitalora_blog_posts', JSON.stringify(blogPosts));
            alert(nextStatus === 'offline' ? 'Blog offline gezet' : 'Blog online gezet');
            window.location.href = '/personeel-dashboard';
            return;
          }
        }

        const scheduleDate = prompt('Voer datum en tijd in (YYYY-MM-DD HH:MM):');
        if (!scheduleDate) return;

        if (!slug) {
          slug = title.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
          blogSlug.value = slug;
        }

        let blogPosts = JSON.parse(localStorage.getItem('vitalora_blog_posts') || '[]');
        if (editId) {
          const index = blogPosts.findIndex(p => p.id == editId);
          if (index !== -1) {
            if (!featuredImage && blogPosts[index].featuredImage) {
              featuredImage = blogPosts[index].featuredImage;
            }
            blogPosts[index] = {
              ...blogPosts[index],
              title,
              slug,
              metaTitle,
              metaDescription,
              content,
              featuredImage,
              status: 'scheduled',
              publishDate: scheduleDate,
              updatedAt: new Date().toISOString()
            };
          }
        } else {
          const newPost = {
            id: Date.now(),
            title,
            slug,
            metaTitle,
            metaDescription,
            content,
            featuredImage,
            status: 'scheduled',
            publishDate: scheduleDate,
            createdAt: new Date().toISOString(),
            readTime: Math.max(3, Math.ceil(content.replace(/<[^>]*>/g, '').split(' ').length / 200))
          };
          blogPosts.unshift(newPost);
        }

        localStorage.setItem('vitalora_blog_posts', JSON.stringify(blogPosts));
        alert('Blog succesvol ingepland!');
        window.location.href = '/personeel-dashboard';
      });
      
      // Publish blog
      publishBtn.addEventListener('click', function() {
        const title = blogTitle.value.trim();
        const slug = blogSlug.value.trim();
        const metaTitle = blogMetaTitle.value.trim();
        const metaDescription = blogMetaDescription.value.trim();
        const content = blogContent.innerHTML;
        let featuredImage = getFeaturedImageFromPreview();
        
        if (!title || !content) {
          alert('Vul titel en inhoud in');
          return;
        }
        
        if (confirm('Weet je zeker dat je deze blog post wilt publiceren?')) {
          // Get existing blog posts
          let blogPosts = JSON.parse(localStorage.getItem('vitalora_blog_posts') || '[]');
          
          if (editId) {
            // Update existing blog post
            const postIndex = blogPosts.findIndex(p => p.id == editId);
            if (postIndex !== -1) {
              const existing = blogPosts[postIndex];
              if (!featuredImage && existing.featuredImage) {
                featuredImage = existing.featuredImage;
              }
              blogPosts[postIndex] = {
                ...existing,
                title,
                slug: slug, // Always use the new slug value
                metaTitle,
                metaDescription,
                content,
                featuredImage,
                status: 'published',
                publishedDate: existing.publishedDate || new Date().toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' }),
                readTime: Math.max(3, Math.ceil(content.replace(/<[^>]*>/g, '').split(' ').length / 200)),
                updatedAt: new Date().toISOString()
              };
              alert('Blog succesvol bijgewerkt!');
            }
          } else {
            // Create new blog post
            const blogPost = {
              id: Date.now(),
              title: title,
              slug: slug,
              metaTitle: metaTitle,
              metaDescription: metaDescription,
              content: content,
              featuredImage: featuredImage,
              status: 'published',
              publishedDate: new Date().toLocaleDateString('nl-NL', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
              }),
              readTime: Math.max(3, Math.ceil(content.replace(/<[^>]*>/g, '').split(' ').length / 200))
            };
            
            // Add new blog post
            blogPosts.unshift(blogPost);
            alert('Blog succesvol gepubliceerd!');
          }
          
          // Save back to localStorage
          localStorage.setItem('vitalora_blog_posts', JSON.stringify(blogPosts));
          
          console.log('Publishing blog:', blogPosts[editId ? blogPosts.findIndex(p => p.id == editId) : 0]);
          window.location.href = '/personeel-dashboard';
        }
      });

      // Delete blog
      deleteBtn.addEventListener('click', function(){
        if(!editId){ return; }
        if(!confirm('Weet je zeker dat je deze blog wilt verwijderen?')) return;
        let blogPosts = JSON.parse(localStorage.getItem('vitalora_blog_posts') || '[]');
        blogPosts = blogPosts.filter(p => p.id != editId);
        localStorage.setItem('vitalora_blog_posts', JSON.stringify(blogPosts));
        alert('Blog verwijderd');
        window.location.href = '/personeel-dashboard';
      });
      
      // Preview opens post.html with current slug in new tab
      const previewBtn = document.getElementById('preview-blog');
      if (previewBtn) {
        previewBtn.addEventListener('click', function(){
          const slug = normalizeSlug(blogSlug.value || blogTitle.value);
          if(!slug){ alert('Vul eerst titel of slug in'); return; }
          // ensure current changes are reflected for preview: save draft temporarily in storage
          try {
            let posts = JSON.parse(localStorage.getItem('vitalora_blog_posts')||'[]');
            const idx = editId ? posts.findIndex(p=>String(p.id)===String(editId)) : -1;
            const doc = {
              id: editId || Date.now(),
              title: blogTitle.value.trim() || slug,
              slug: slug,
              metaTitle: blogMetaTitle.value.trim(),
              metaDescription: blogMetaDescription.value.trim(),
              content: blogContent.innerHTML,
              featuredImage: (function(){
                const img= document.getElementById('image-preview')?.querySelector('img');
                return img? img.src : (idx>=0 && posts[idx] && posts[idx].featuredImage) ? posts[idx].featuredImage : null;
              })(),
              status: (idx>=0 && posts[idx].status) || 'draft',
              updatedAt: new Date().toISOString()
            };
            if (idx>=0) { posts[idx]= { ...posts[idx], ...doc }; } else { posts.unshift(doc); }
            localStorage.setItem('vitalora_blog_posts', JSON.stringify(posts));
          } catch(_){}
          window.open('/post.html?slug=' + encodeURIComponent(slug), '_blank');
        });
      }
      
    })();
  </script>
</body>
</html>
