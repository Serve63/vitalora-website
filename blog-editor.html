<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog Editor - Vitalora</title>
  <link rel="stylesheet" href="styles.css?v=2" />
  <link rel="stylesheet" href="/assets/css/header.css?v=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/fonts.css?v=12">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.3/tinymce.min.js" referrerpolicy="origin"></script>
  <style>
    :root{--brand:#3A9AEA;--ink:#0f172a;--muted:#64748b}
    body{background:#f3f6fb; margin: 0; font-family: 'Quicksand', sans-serif;}
    
    .editor-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .editor-header {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .editor-title {
      font-size: 28px;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 8px 0;
    }
    
    .editor-subtitle {
      color: #6b7280;
      font-size: 16px;
      margin: 0;
    }
    
    .editor-form {
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .form-group {
      margin-bottom: 24px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      font-family: inherit;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-row {
      display: flex;
      gap: 16px;
    }
    
    .form-row .form-group {
      flex: 1;
    }
    
    .editor-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 16px;
      background: #f9fafb;
      border: 1px solid #d1d5db;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
    }
    
    .toolbar-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.2s ease;
    }
    
    .toolbar-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }
    
    .toolbar-btn.active {
      background: #10b981;
      color: white;
    }
    
    .editor-content {
      width: 100%;
      min-height: 400px;
      padding: 20px;
      border: 1px solid #d1d5db;
      border-radius: 0 0 8px 8px;
      font-family: inherit;
      font-size: 16px;
      line-height: 1.6;
      box-sizing: border-box;
      background: white;
      outline: none;
      color: #333333 !important;
    }

    .editor-content.mce-content-body {
      outline: none;
    }

    .editor-content.mce-content-body.mce-edit-focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .editor-content * {
      color: inherit !important;
    }
    
    .editor-content a {
      color: #3b82f6 !important;
      text-decoration: underline;
    }
    
    .editor-content blockquote {
      background: #2954B4;
      color: white !important;
      padding: 16px 20px;
      margin: 16px 0;
      border-radius: 8px;
      border-left: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      font-style: normal;
      position: relative;
    }
    
    .editor-content blockquote * {
      color: white !important;
    }
    
    .editor-content blockquote:before {
      content: '"';
      font-size: 24px;
      color: rgba(255,255,255,0.7);
      position: absolute;
      left: 8px;
      top: 8px;
    }
    
    .editor-content blockquote:after {
      content: '"';
      font-size: 24px;
      color: rgba(255,255,255,0.7);
      position: absolute;
      right: 8px;
      bottom: 8px;
    }
    
    .editor-content .summary-box {
      background: white;
      border-radius: 8px;
      margin: 16px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      border-left: 4px solid #2954B4;
    }
    
    .editor-content .summary-header {
      background: #2954B4;
      color: white !important;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    .editor-content .summary-header * { color: white !important; }
    
    .editor-content .summary-header .icon {
      width: 20px;
      height: 20px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .editor-content .summary-content {
      padding: 16px;
      color: #333333;
      min-height: 40px;
    }
    
    .editor-content .summary-content:empty:before {
      content: "In het kort...";
      color: #9ca3af;
      font-style: italic;
    }
    
    .editor-content:empty:before {
      content: attr(placeholder);
      color: #9ca3af;
      pointer-events: none;
    }
    
    .editor-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary {
      background: #10b981;
      color: white;
    }
    
    .btn-primary:hover {
      background: #059669;
    }
    
    .btn-outline {
      background: transparent;
      color: #6b7280;
      border: 1px solid #d1d5db;
    }
    
    .btn-outline:hover {
      background: #f9fafb;
    }
    .btn-danger { background:#ef4444; color:#fff; }
    .btn-danger:hover { background:#dc2626; }
    
    .image-upload-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .image-preview {
      width: 100%;
      height: 200px;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f9fafb;
      overflow: hidden;
    }
    
    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .image-placeholder {
      color: #6b7280;
      font-size: 14px;
      text-align: center;
    }
    
    .image-hint {
      color: #6b7280;
      font-size: 12px;
      margin: 8px 0 0 0;
      font-style: italic;
    }
    
    .back-link {
      color: #6b7280;
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 16px;
      display: inline-block;
    }
    
    .back-link:hover {
      color: #374151;
    }
    
    @media (max-width: 768px) {
      .editor-container {
        padding: 16px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .editor-actions {
        flex-direction: column;
      }
    }
  </style>
<link rel="icon" type="image/webp" href="/assets/images/vitalora logo.webp">
<link rel="shortcut icon" type="image/webp" href="/assets/images/vitalora logo.webp">
</head>
<body>
  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="header-inner">
      <a class="logo" href="/">
        <span class="logo-text">Vitalora.nl</span>
      </a>
      
      <div class="header-buttons">
        <!-- Header buttons removed for editor -->
      </div>
    </div>
  </header>

  <div class="editor-container">
    <a href="/personeel-dashboard" class="back-link">‚Üê Terug naar dashboard</a>
    
    <div class="editor-header">
      <h1 class="editor-title">Blog Inhoud</h1>
      <p class="editor-subtitle">Maak een nieuwe blog post</p>
    </div>
    
    <form class="editor-form">
      <div class="form-group">
        <label class="form-label">Titel</label>
        <input type="text" class="form-input" id="blog-title" placeholder="Voer blog titel in">
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">URL</label>
          <input type="text" class="form-input" id="blog-slug" placeholder="blog-url">
          <small id="slug-hint" style="display:block;color:#64748b;margin-top:4px">Uniek, alleen letters/cijfers/koppelteken</small>
        </div>
        <div class="form-group">
          <label class="form-label">Publicatiedatum</label>
          <input type="date" class="form-input" id="blog-date" placeholder="jjjj-mm-dd">
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Meta Titel</label>
        <input type="text" class="form-input" id="blog-meta-title" placeholder="SEO titel voor zoekmachines">
      </div>
      
      <div class="form-group">
        <label class="form-label">Meta Beschrijving</label>
        <textarea class="form-input" id="blog-meta-description" rows="3" placeholder="SEO beschrijving voor zoekmachines (max 160 karakters)"></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Header Afbeelding</label>
        <div class="image-upload-section">
          <div class="image-preview" id="image-preview">
            <div class="image-placeholder">
              <span>Geen afbeelding geselecteerd</span>
            </div>
          </div>
          <button type="button" class="btn btn-outline" id="upload-image-btn">
            üì∑ Afbeelding uploaden
          </button>
          <input type="file" id="image-input" accept="image/*" style="display: none;">
          <p class="image-hint">Aanbevolen formaat: 800x450px</p>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Inhoud</label>
        <div class="editor-toolbar">
          <button type="button" class="toolbar-btn" title="Vet">B</button>
          <button type="button" class="toolbar-btn" title="Cursief">I</button>
          <button type="button" class="toolbar-btn" title="Onderstreept">U</button>
          <button type="button" class="toolbar-btn" title="Normale Tekst">P</button>
          <button type="button" class="toolbar-btn" title="Kop 1">H1</button>
          <button type="button" class="toolbar-btn" title="Kop 2">H2</button>
          <button type="button" class="toolbar-btn" title="Kop 3">H3</button>
          <button type="button" class="toolbar-btn" title="Kop 4">H4</button>
          <button type="button" class="toolbar-btn" title="Quote">"</button>
          <button type="button" class="toolbar-btn" title="Kort">üìã</button>
          <button type="button" class="toolbar-btn" title="Afbeelding Toevoegen">üñºÔ∏è</button>
        </div>
        <div class="editor-content" id="blog-content" placeholder="Begin met het schrijven van je blog post..."></div>
      </div>
      
      <div class="editor-actions">
        <button type="button" class="btn btn-outline" id="save-draft">Concept Opslaan</button>
        <button type="button" class="btn btn-outline" id="schedule-blog">Inplannen</button>
        <button type="button" class="btn btn-primary" id="publish-blog">Publiceren</button>
        <button type="button" class="btn btn-secondary" id="preview-blog">Preview</button>
        <button type="button" class="btn btn-danger" id="delete-blog" style="display:none;">Verwijderen</button>
      </div>
    </form>
  </div>

  <script>
    (function(){
      // Check if user has access
      const key='staff_access_ok';
      if(localStorage.getItem(key)!=='1'){ 
        window.location.href='/personeel'; 
        return; 
      }
      
      // Get elements
      const blogTitle = document.getElementById('blog-title');
      const blogSlug = document.getElementById('blog-slug');
      const slugHint = document.getElementById('slug-hint');
      const blogMetaTitle = document.getElementById('blog-meta-title');
      const blogMetaDescription = document.getElementById('blog-meta-description');
      const blogContent = document.getElementById('blog-content');
      const blogDate = document.getElementById('blog-date');
      const saveDraftBtn = document.getElementById('save-draft');
      const scheduleBtn = document.getElementById('schedule-blog');
      const publishBtn = document.getElementById('publish-blog');
      const deleteBtn = document.getElementById('delete-blog');
      
      // Image upload elements
      const imagePreview = document.getElementById('image-preview');
      const uploadImageBtn = document.getElementById('upload-image-btn');
      const imageInput = document.getElementById('image-input');
      
      // Check if we're editing an existing post
      const urlParams = new URLSearchParams(window.location.search);
      const editId = urlParams.get('edit');

      function getEditorRoot(editor) {
        if (editor && typeof editor.getBody === 'function') {
          return editor.getBody();
        }
        return blogContent;
      }

      function normalizeSummaryHeadersInEditor(editor) {
        try {
          const root = getEditorRoot(editor);
          if (!root) return;
          root.querySelectorAll('.summary-header').forEach(function(header) {
            const doc = header.ownerDocument || document;
            const iconCandidates = Array.from(header.children || []).filter(child => child.classList && child.classList.contains('icon'));
            let iconEl = iconCandidates[0] || null;
            if (!iconEl) {
              iconEl = doc.createElement('div');
              iconEl.className = 'icon';
              header.insertBefore(iconEl, header.firstChild);
            }
            iconEl.textContent = 'üìã';
            if (iconEl !== header.firstChild) {
              header.insertBefore(iconEl, header.firstChild);
            }
            iconCandidates.slice(1).forEach(extra => {
              if (extra && extra.parentNode) {
                extra.parentNode.removeChild(extra);
              }
            });

            let titleEl = header.querySelector('.summary-title');
            if (titleEl) {
              const extraTitles = header.querySelectorAll('.summary-title');
              extraTitles.forEach((node, index) => {
                if (index === 0) return;
                while (node.firstChild) {
                  titleEl.appendChild(node.firstChild);
                }
                if (node.parentNode) {
                  node.parentNode.removeChild(node);
                }
              });
            } else {
              titleEl = doc.createElement('span');
              titleEl.className = 'summary-title';
            }

            const nodesToMove = [];
            Array.from(header.childNodes).forEach(node => {
              if (node === iconEl || node === titleEl) return;
              if (node.nodeType === 3 && !node.textContent.trim()) {
                if (node.parentNode) {
                  node.parentNode.removeChild(node);
                }
                return;
              }
              if (titleEl && node.parentNode === header) {
                nodesToMove.push(node);
              }
            });
            nodesToMove.forEach(node => titleEl.appendChild(node));

            if (!titleEl.textContent.trim()) {
              titleEl.textContent = 'In het kort...';
            }

            if (titleEl.parentNode !== header) {
              header.insertBefore(titleEl, iconEl.nextSibling);
            } else if (titleEl.previousSibling !== iconEl) {
              header.insertBefore(titleEl, iconEl.nextSibling);
            }
          });

          root.querySelectorAll('.summary-content').forEach(function(content) {
            if (!content.hasAttribute('contenteditable')) {
              content.setAttribute('contenteditable', 'true');
            }
          });
        } catch(_) {}
      }

      function ensureParagraphAfterSummaryBoxes(editor) {
        const root = getEditorRoot(editor);
        if (!root) return;
        root.querySelectorAll('.summary-box').forEach(function(box) {
          const next = box.nextSibling && box.nextSibling.nodeType === 1 ? box.nextSibling : box.nextElementSibling;
          if (!next || (next.tagName !== 'P' && !next.classList?.contains('summary-box'))) {
            if (editor && editor.dom) {
              const paragraph = editor.dom.create('p', {}, '<br>');
              editor.dom.insertAfter(paragraph, box);
            } else {
              const p = document.createElement('p');
              p.innerHTML = '<br>';
              box.insertAdjacentElement('afterend', p);
            }
          }
        });
      }

      function placeCaret(editor, element) {
        if (!element) return;
        if (editor && editor.selection) {
          try {
            editor.selection.select(element);
            editor.selection.collapse(false);
            return;
          } catch(_) {}
        }
        try {
          const range = document.createRange();
          range.selectNodeContents(element);
          range.collapse(false);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        } catch(_) {}
      }

      let editorInstance = null;
      const editorReady = (function initEditor() {
        return new Promise((resolve, reject) => {
          if (!window.tinymce) {
            reject(new Error('TinyMCE kon niet worden geladen.'));
            return;
          }
          tinymce.init({
            selector: '#blog-content',
            inline: true,
            menubar: false,
            toolbar: false,
            plugins: 'link lists image paste',
            forced_root_block: 'p',
            convert_fonts_to_spans: false,
            browser_spellcheck: true,
            valid_elements: '*[*]',
            extended_valid_elements: 'div[*],span[*],p[*],img[*],blockquote[*],h1[*],h2[*],h3[*],h4[*],section[*],article[*]',
            content_style: `body { font-family: 'Quicksand', sans-serif; font-size: 16px; line-height: 1.6; color: #333333; }
blockquote { background: #2954B4; color: white; padding: 16px 20px; margin: 16px 0; border-radius: 8px; border-left: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-style: normal; position: relative; }
blockquote:before { content: '\"'; font-size: 24px; color: rgba(255,255,255,0.7); position: absolute; left: 8px; top: 8px; }
blockquote:after { content: '\"'; font-size: 24px; color: rgba(255,255,255,0.7); position: absolute; right: 8px; bottom: 8px; }
.summary-box { background: white; border-radius: 8px; margin: 16px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; border-left: 4px solid #2954B4; }
.summary-header { background: #2954B4; color: white; padding: 12px 16px; display: flex; align-items: center; gap: 8px; font-weight: 600; }
.summary-header .icon { width: 20px; height: 20px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
.summary-content { padding: 16px; color: #333333; min-height: 40px; }
.summary-content:empty:before { content: 'In het kort...'; color: #9ca3af; font-style: italic; }`,
            formats: {
              paragraph: { block: 'p' },
              h1: { block: 'h1' },
              h2: { block: 'h2' },
              h3: { block: 'h3' },
              h4: { block: 'h4' },
              blockquote: { block: 'blockquote' }
            },
            placeholder: blogContent?.getAttribute('placeholder') || 'Begin met het schrijven van je blog post...',
            setup(editor) {
              editorInstance = editor;
              const syncSummary = () => {
                normalizeSummaryHeadersInEditor(editor);
                ensureParagraphAfterSummaryBoxes(editor);
              };
              editor.on('init', () => {
                syncSummary();
                resolve(editor);
              });
              editor.on('SetContent', syncSummary);
              editor.on('NodeChange', syncSummary);
              editor.on('keydown', (e) => {
                const target = e.target;
                if (target && target.classList && target.classList.contains('summary-content')) {
                  if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const box = target.closest('.summary-box');
                    if (!box) return;
                    const paragraph = editor.dom.create('p', {}, '<br>');
                    editor.dom.insertAfter(paragraph, box);
                    placeCaret(editor, paragraph);
                  }
                }
              });
            }
          });
        });
      })();

      editorReady.catch(err => {
        console.error(err);
        alert('De teksteditor kon niet worden geladen. Vernieuw de pagina.');
      });
      
      let existingPost = null;
      if (editId) {
        const blogPosts = JSON.parse(localStorage.getItem('vitalora_blog_posts') || '[]');
        existingPost = blogPosts.find(p => p.id == editId);

        if (existingPost) {
          blogTitle.value = existingPost.title;
          blogSlug.value = existingPost.slug;
          blogMetaTitle.value = existingPost.metaTitle;
          blogMetaDescription.value = existingPost.metaDescription;
          if (blogDate) {
            const d = existingPost.publishedDate || existingPost.publishDate || '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(d)) blogDate.value = d;
          }

          if (existingPost.featuredImage) {
            const img = document.createElement('img');
            img.src = existingPost.featuredImage;
            img.alt = 'Header afbeelding';
            imagePreview.innerHTML = '';
            imagePreview.appendChild(img);
          }

          document.title = 'Bewerk: ' + existingPost.title + ' - Vitalora';
          document.querySelector('.editor-title').textContent = 'Blog Bewerken';
          document.querySelector('.editor-subtitle').textContent = 'Bewerk je bestaande blog post';
          publishBtn.textContent = 'Bijwerken';
          saveDraftBtn.textContent = 'Als concept opslaan';
          scheduleBtn.textContent = 'Opnieuw inplannen';
          deleteBtn.style.display = 'inline-block';
          if (existingPost.status === 'published') {
            scheduleBtn.textContent = 'Offline zetten';
          } else if (existingPost.status === 'offline') {
            scheduleBtn.textContent = 'Online zetten';
          }
        }
      }

      editorReady.then(editor => {
        if (existingPost && existingPost.content) {
          editor.setContent(existingPost.content);
        } else {
          editor.setContent('');
        }
        normalizeSummaryHeadersInEditor(editor);
        ensureParagraphAfterSummaryBoxes(editor);
      }).catch(() => {});
      
      // Handle clicking outside summary content to exit
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.summary-content')) {
          const root = getEditorRoot(editorInstance);
          if (!root) return;
          root.querySelectorAll('.summary-content').forEach(content => {
            if (content === document.activeElement) {
              content.blur();
            }
          });
        }
      });
      
      function normalizeSlug(input){
        return (input||'').toLowerCase().replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');
      }

      function escapeHtml(value) {
        return String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function isUniqueSlug(slug, ignoreId){
        try {
          const posts = JSON.parse(localStorage.getItem('vitalora_blog_posts')||'[]');
          return !posts.some(p => p.slug === slug && String(p.id) !== String(ignoreId||''));
        } catch(_) { return true; }
      }

      blogTitle.addEventListener('blur', function(){
        if(!blogSlug.value.trim()){
          blogSlug.value = normalizeSlug(blogTitle.value);
        }
      });

      blogSlug.addEventListener('input', function(){
        const normalized = normalizeSlug(blogSlug.value);
        if (blogSlug.value !== normalized) blogSlug.value = normalized;
        const ok = isUniqueSlug(blogSlug.value, editId);
        slugHint.style.color = ok ? '#64748b' : '#ef4444';
        slugHint.textContent = ok ? 'Uniek, alleen letters/cijfers/koppelteken' : 'Slug is al in gebruik';
      });

      const toolbarButtons = document.querySelectorAll('.toolbar-btn');
      toolbarButtons.forEach(btn => {
        btn.addEventListener('click', async function() {
          const command = this.title.toLowerCase();
          try {
            const editor = await editorReady;
            editor.focus();
            switch(command) {
              case 'vet':
                editor.formatter.toggle('bold');
                break;
              case 'cursief':
                editor.formatter.toggle('italic');
                break;
              case 'onderstreept':
                editor.formatter.toggle('underline');
                break;
              case 'normale tekst':
                ['bold','italic','underline','h1','h2','h3','h4','blockquote'].forEach(fmt => editor.formatter.remove(fmt));
                editor.formatter.apply('paragraph');
                break;
              case 'kop 1':
                editor.formatter.toggle('h1');
                break;
              case 'kop 2':
                editor.formatter.toggle('h2');
                break;
              case 'kop 3':
                editor.formatter.toggle('h3');
                break;
              case 'kop 4':
                editor.formatter.toggle('h4');
                break;
              case 'quote':
                editor.formatter.toggle('blockquote');
                break;
              case 'kort': {
                let summaryTitle = prompt('Voer titel in voor "Kort" sectie:', 'In het kort...');
                if (summaryTitle) summaryTitle = summaryTitle.trim();
                if (!summaryTitle) summaryTitle = 'In het kort...';
                const summaryHTML = `
                  <div class="summary-box">
                    <div class="summary-header">
                      <div class="icon">üìã</div>
                      <span class="summary-title">${escapeHtml(summaryTitle)}</span>
                    </div>
                    <div class="summary-content" contenteditable="true"></div>
                  </div>`;
                editor.insertContent(summaryHTML);
                setTimeout(() => {
                  normalizeSummaryHeadersInEditor(editor);
                  ensureParagraphAfterSummaryBoxes(editor);
                  const lastContent = getEditorRoot(editor)?.querySelector('.summary-box:last-of-type .summary-content');
                  if (lastContent) {
                    lastContent.focus();
                  }
                }, 0);
                break;
              }
              case 'afbeelding toevoegen': {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = function(e) {
                  const file = e.target.files[0];
                  if (file) {
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                      const imgHtml = `<img src="${evt.target.result}" alt="Afbeelding" style="max-width:100%; height:auto;">`;
                      editor.insertContent(imgHtml);
                    };
                    reader.readAsDataURL(file);
                  }
                };
                fileInput.click();
                break;
              }
            }
          } catch(err) {
            console.error('Editor niet beschikbaar', err);
          }
        });
      });

      // Image upload functionality
      uploadImageBtn.addEventListener('click', function() {
        imageInput.click();
      });
      
      imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.alt = 'Header afbeelding';
            imagePreview.innerHTML = '';
            imagePreview.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      });
      
      function getFeaturedImageFromPreview() {
        const previewImg = imagePreview.querySelector('img');
        return previewImg ? previewImg.src : null;
      }

      // Save as draft (create or update)
      saveDraftBtn.addEventListener('click', async function() {
        let editor;
        try {
          editor = await editorReady;
        } catch (err) {
          alert('De editor is nog niet geladen. Probeer het opnieuw.');
          return;
        }

        const title = blogTitle.value.trim();
        let slug = blogSlug.value.trim();
        const metaTitle = blogMetaTitle.value.trim();
        const metaDescription = blogMetaDescription.value.trim();
        const content = editor.getContent({ format: 'html' });
        const textContent = editor.getContent({ format: 'text' }).trim();
        let featuredImage = getFeaturedImageFromPreview();

        if (!title) {
          alert('Vul de titel in');
          return;
        }

        if (!slug) {
          slug = title.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
          blogSlug.value = slug;
        }

        let blogPosts = JSON.parse(localStorage.getItem('vitalora_blog_posts') || '[]');
        if (editId) {
          const index = blogPosts.findIndex(p => p.id == editId);
          if (index !== -1) {
            if (!featuredImage && blogPosts[index].featuredImage) {
              featuredImage = blogPosts[index].featuredImage;
            }
            blogPosts[index] = {
              ...blogPosts[index],
              title,
              slug,
              metaTitle,
              metaDescription,
              content,
              featuredImage,
              status: 'draft',
              updatedAt: new Date().toISOString()
            };
          }
        } else {
          const cleanWords = textContent ? textContent.split(/\s+/).filter(Boolean).length : 0;
          const newPost = {
            id: Date.now(),
            title,
            slug,
            metaTitle,
            metaDescription,
            content,
            featuredImage,
            status: 'draft',
            createdAt: new Date().toISOString(),
            readTime: Math.max(3, Math.ceil(cleanWords / 200))
          };
          blogPosts.unshift(newPost);
        }

        localStorage.setItem('vitalora_blog_posts', JSON.stringify(blogPosts));
        alert('Concept succesvol opgeslagen!');
        window.location.href = '/personeel-dashboard';
      });
      
      // Schedule or toggle offline/online in edit mode
      scheduleBtn.addEventListener('click', async function() {
        let editor;
        try {
          editor = await editorReady;
        } catch (err) {
          alert('De editor is nog niet geladen. Probeer het opnieuw.');
          return;
        }

        const title = blogTitle.value.trim();
        let slug = blogSlug.value.trim();
        const metaTitle = blogMetaTitle.value.trim();
        const metaDescription = blogMetaDescription.value.trim();
        const content = editor.getContent({ format: 'html' });
        const textContent = editor.getContent({ format: 'text' }).trim();
        let featuredImage = getFeaturedImageFromPreview();

        if (!title || !textContent) {
          alert('Vul titel en inhoud in');
          return;
        }

        // If in edit mode and button says Offline/Online zetten, toggle
        if (editId && (this.textContent.includes('Offline') || this.textContent.includes('Online'))) {
          let blogPosts = JSON.parse(localStorage.getItem('vitalora_blog_posts') || '[]');
          const index = blogPosts.findIndex(p => p.id == editId);
          if (index !== -1) {
            const nextStatus = this.textContent.includes('Offline') ? 'offline' : 'published';
            blogPosts[index].status = nextStatus;
            localStorage.setItem('vitalora_blog_posts', JSON.stringify(blogPosts));
            alert(nextStatus === 'offline' ? 'Blog offline gezet' : 'Blog online gezet');
            window.location.href = '/personeel-dashboard';
            return;
          }
        }

        const scheduleDate = (blogDate && blogDate.value) ? blogDate.value : prompt('Voer datum (YYYY-MM-DD):');
        if (!scheduleDate) return;

        if (!slug) {
          slug = title.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
          blogSlug.value = slug;
        }

        let blogPosts = JSON.parse(localStorage.getItem('vitalora_blog_posts') || '[]');
        if (editId) {
          const index = blogPosts.findIndex(p => p.id == editId);
          if (index !== -1) {
            if (!featuredImage && blogPosts[index].featuredImage) {
              featuredImage = blogPosts[index].featuredImage;
            }
            blogPosts[index] = {
              ...blogPosts[index],
              title,
              slug,
              metaTitle,
              metaDescription,
              content,
              featuredImage,
              status: 'scheduled',
              publishDate: scheduleDate,
              updatedAt: new Date().toISOString()
            };
          }
        } else {
          const cleanWords = textContent ? textContent.split(/\s+/).filter(Boolean).length : 0;
          const newPost = {
            id: Date.now(),
            title,
            slug,
            metaTitle,
            metaDescription,
            content,
            featuredImage,
            status: 'scheduled',
            publishDate: scheduleDate,
            createdAt: new Date().toISOString(),
            readTime: Math.max(3, Math.ceil(cleanWords / 200))
          };
          blogPosts.unshift(newPost);
        }

        localStorage.setItem('vitalora_blog_posts', JSON.stringify(blogPosts));
        alert('Blog succesvol ingepland!');
        window.location.href = '/personeel-dashboard';
      });
      
      // Publish blog
      publishBtn.addEventListener('click', async function() {
        let editor;
        try {
          editor = await editorReady;
        } catch (err) {
          alert('De editor is nog niet geladen. Probeer het opnieuw.');
          return;
        }

        const title = blogTitle.value.trim();
        const slug = blogSlug.value.trim();
        const metaTitle = blogMetaTitle.value.trim();
        const metaDescription = blogMetaDescription.value.trim();
        const content = editor.getContent({ format: 'html' });
        const textContent = editor.getContent({ format: 'text' }).trim();
        let featuredImage = getFeaturedImageFromPreview();

        if (!title || !textContent) {
          alert('Vul titel en inhoud in');
          return;
        }

        if (confirm('Weet je zeker dat je deze blog post wilt publiceren?')) {
          let blogPosts = JSON.parse(localStorage.getItem('vitalora_blog_posts') || '[]');

          if (editId) {
            const postIndex = blogPosts.findIndex(p => p.id == editId);
            if (postIndex !== -1) {
              const existing = blogPosts[postIndex];
              if (!featuredImage && existing.featuredImage) {
                featuredImage = existing.featuredImage;
              }
              const cleanWords = textContent ? textContent.split(/\s+/).filter(Boolean).length : 0;
              blogPosts[postIndex] = {
                ...existing,
                title,
                slug: slug,
                metaTitle,
                metaDescription,
                content,
                featuredImage,
                status: 'published',
                publishedDate: (blogDate && blogDate.value) ? blogDate.value : (existing.publishedDate || new Date().toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' })),
                readTime: Math.max(3, Math.ceil(cleanWords / 200)),
                updatedAt: new Date().toISOString()
              };
              alert('Blog succesvol bijgewerkt!');
            }
          } else {
            const cleanWords = textContent ? textContent.split(/\s+/).filter(Boolean).length : 0;
            const blogPost = {
              id: Date.now(),
              title: title,
              slug: slug,
              metaTitle: metaTitle,
              metaDescription: metaDescription,
              content: content,
              featuredImage: featuredImage,
              status: 'published',
              publishedDate: (blogDate && blogDate.value) ? blogDate.value : new Date().toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' }),
              readTime: Math.max(3, Math.ceil(cleanWords / 200))
            };

            blogPosts.unshift(blogPost);
            alert('Blog succesvol gepubliceerd!');
          }

          localStorage.setItem('vitalora_blog_posts', JSON.stringify(blogPosts));

          console.log('Publishing blog:', blogPosts[editId ? blogPosts.findIndex(p => p.id == editId) : 0]);
          window.location.href = '/personeel-dashboard';
        }
      });

      // Delete blog
      deleteBtn.addEventListener('click', function(){
        if(!editId){ return; }
        if(!confirm('Weet je zeker dat je deze blog wilt verwijderen?')) return;
        let blogPosts = JSON.parse(localStorage.getItem('vitalora_blog_posts') || '[]');
        blogPosts = blogPosts.filter(p => p.id != editId);
        localStorage.setItem('vitalora_blog_posts', JSON.stringify(blogPosts));
        alert('Blog verwijderd');
        window.location.href = '/personeel-dashboard';
      });
      
      // Preview opens post.html with current slug in new tab
      const previewBtn = document.getElementById('preview-blog');
      if (previewBtn) {
        previewBtn.addEventListener('click', async function(){
          const slug = normalizeSlug(blogSlug.value || blogTitle.value);
          if(!slug){ alert('Vul eerst titel of slug in'); return; }
          // ensure current changes are reflected for preview: save draft temporarily in storage
          try {
            const editor = await editorReady;
            let posts = JSON.parse(localStorage.getItem('vitalora_blog_posts')||'[]');
            const idx = editId ? posts.findIndex(p=>String(p.id)===String(editId)) : -1;
            const doc = {
              id: editId || Date.now(),
              title: blogTitle.value.trim() || slug,
              slug: slug,
              metaTitle: blogMetaTitle.value.trim(),
              metaDescription: blogMetaDescription.value.trim(),
              content: editor.getContent({ format: 'html' }),
              featuredImage: (function(){
                const img= document.getElementById('image-preview')?.querySelector('img');
                return img? img.src : (idx>=0 && posts[idx] && posts[idx].featuredImage) ? posts[idx].featuredImage : null;
              })(),
              status: (idx>=0 && posts[idx].status) || 'draft',
              updatedAt: new Date().toISOString()
            };
            if (idx>=0) { posts[idx]= { ...posts[idx], ...doc }; } else { posts.unshift(doc); }
            localStorage.setItem('vitalora_blog_posts', JSON.stringify(posts));
          } catch(err){
            console.error('Preview kon niet worden voorbereid', err);
            alert('De editor is nog niet geladen. Probeer het opnieuw.');
            return;
          }
          window.open('/post.html?slug=' + encodeURIComponent(slug), '_blank');
        });
      }
      
    })();
  </script>
</body>
</html>
